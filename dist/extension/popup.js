(()=>{(()=>{var c=class{constructor(){this.apiKey=null,this.currentTab=null,this.chatHistory=[],this.pageContent=null,this.isLoading=!1,this.currentDomain=null,this.darkModeToggle=document.getElementById("dark-mode-toggle"),this.isDarkMode=!1,this.maxCharCount=2e3,this.charCount=document.querySelector(".char-count"),this.formatButtons=document.querySelectorAll(".format-button, .tool-button"),this.inputBar=document.querySelector(".input-bar"),this.messageInput=document.getElementById("message-input"),this.sendButton=document.getElementById("send-button"),this.messagesContainer=document.getElementById("messages-container"),this.pageStatus=document.getElementById("page-status"),this.pageTitle=document.getElementById("page-title"),this.quickActions=document.getElementById("quick-actions"),this.sidebar=document.getElementById("sidebar"),this.quickTwitterBtn=document.getElementById("quick-twitter"),this.quickThreadBtn=document.getElementById("quick-thread"),this.welcomeView=document.getElementById("welcome-view"),this.apiSetupView=document.getElementById("api-setup-view"),this.chatView=document.getElementById("chat-view"),this.settingsView=document.getElementById("settings-view"),this.menuButton=document.getElementById("menu-button"),this.apiKeyInput=document.getElementById("api-key-input")||document.getElementById("settings-api-key"),this.inputActions=document.querySelector(".input-actions"),this.exportFormatSelect=document.getElementById("export-format-select"),this.statusText=document.getElementById("status-text"),this.views={welcome:this.welcomeView,"api-setup":this.apiSetupView,chat:this.chatView,settings:this.settingsView}}async init(){console.log("TabTalk AI: Initializing popup"),this.currentTab=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0],await this.loadState(),this.bindEvents();let t=await this.getStorageItem("hasSeenWelcome");this.apiKey?(this.showView("chat"),await this.getAndCachePageContent()):t?this.showView("api-setup"):this.showView("welcome"),console.log("TabTalk AI: Popup initialized")}bindEvents(){let t=document.getElementById("settings-cancel-button"),e=document.getElementById("settings-save-button");t&&t.addEventListener("click",()=>{this.updateViewState(this.apiKey?"chat":"settings")}),e&&e.addEventListener("click",()=>this.handleSaveSettings());let a=document.getElementById("delete-api-key-button");a&&a.addEventListener("click",()=>this.handleDeleteApiKey()),console.log("Menu Button:",this.menuButton),console.log("Sidebar:",this.sidebar),this.menuButton&&this.sidebar&&(this.menuButton.addEventListener("click",s=>{s.stopPropagation(),console.log("Menu button clicked!");let d=this.sidebar.classList.contains("hidden");d?(this.sidebar.classList.remove("hidden"),this.sidebar.style.display="block"):(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none"),console.log("Sidebar is now:",d?"visible":"hidden"),this.sidebar.setAttribute("aria-expanded",d?"false":"true")}),document.addEventListener("click",s=>{this.sidebar.classList.contains("hidden")||!this.sidebar.contains(s.target)&&s.target!==this.menuButton&&(this.sidebar.classList.add("hidden"),this.sidebar.setAttribute("aria-expanded","false"))}),this.sidebar.addEventListener("keydown",s=>{s.key==="Escape"&&(this.sidebar.classList.add("hidden"),this.sidebar.setAttribute("aria-expanded","false"),this.menuButton.focus())}));let n=document.getElementById("menu-settings-link");n&&n.addEventListener("click",s=>{s.preventDefault(),this.updateViewState("settings"),this.sidebar&&this.sidebar.classList.add("hidden")});let r=document.getElementById("menu-refresh-link");r&&r.addEventListener("click",async s=>{s.preventDefault(),confirm("Clear all chat history for this page?")&&(this.chatHistory=[],await this.saveState(),this.renderMessages()),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")});let i=document.getElementById("welcome-get-started");i&&i.addEventListener("click",async()=>{await this.setStorageItem("hasSeenWelcome",!0),this.showView("api-setup")});let l=document.getElementById("welcome-start");l&&l.addEventListener("click",async()=>{await this.setStorageItem("hasSeenWelcome",!0),this.showView("api-setup")});let u=document.getElementById("api-setup-back");u&&u.addEventListener("click",()=>{this.showView("welcome")});let h=document.getElementById("api-setup-back-arrow");h&&h.addEventListener("click",()=>{this.showView("welcome")});let w=document.getElementById("api-setup-continue");w&&w.addEventListener("click",async()=>{let s=document.getElementById("onboarding-api-key").value.trim();s&&(await this.saveApiKey(s),this.showView("chat"),await this.getAndCachePageContent())});let o=document.getElementById("test-api-key");o&&o.addEventListener("click",async()=>{let s=document.getElementById("onboarding-api-key").value.trim();if(s){let d=await this.testApiKey(s),S=document.getElementById("api-setup-continue");d?(o.textContent="\u2713 Valid",o.style.background="#10b981",o.style.color="white",S.disabled=!1):(o.textContent="\u2717 Invalid",o.style.background="#ef4444",o.style.color="white",S.disabled=!0),setTimeout(()=>{o.textContent="Test",o.style.background="",o.style.color=""},2e3)}});let y=document.getElementById("onboarding-api-key");y&&y.addEventListener("input",()=>{let s=document.getElementById("api-setup-continue");s.disabled=!y.value.trim()});let b=document.getElementById("menu-faq-link");b&&b.addEventListener("click",async s=>{s.preventDefault(),await this.generateSpecialContent("faq"),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")}),this.sendButton&&this.sendButton.addEventListener("click",()=>this.sendMessage()),this.messageInput&&(this.messageInput.addEventListener("input",()=>this.handleInputChange()),this.messageInput.addEventListener("keydown",s=>this.handleInputKeydown(s)),this.messageInput.addEventListener("focus",()=>{this.inputBar.classList.add("focused"),this.messageInput.setAttribute("aria-expanded","true")}),this.messageInput.addEventListener("blur",()=>{this.inputBar.classList.remove("focused"),this.messageInput.setAttribute("aria-expanded","false")}));let g=this.inputActions?this.inputActions.querySelector("#clear-chat-button"):document.getElementById("clear-chat-button");g&&g.addEventListener("click",async()=>{confirm("Clear all chat history for this page?")&&(this.chatHistory=[],await this.saveState(),this.renderMessages())});let p=this.inputActions?this.inputActions.querySelector("#export-chat-button"):document.getElementById("export-chat-button");p&&p.addEventListener("click",()=>this.handleExportChat());let m=this.inputActions?this.inputActions.querySelector("#export-format-select"):document.getElementById("export-format-select");m&&m.setAttribute("aria-label","Export format"),this.sendButton&&this.sendButton.setAttribute("aria-label","Send message"),g&&g.setAttribute("aria-label","Clear chat history"),p&&p.setAttribute("aria-label","Export chat"),m&&m.setAttribute("aria-label","Export format"),this.menuButton&&this.menuButton.setAttribute("aria-label","Open menu"),this.apiKeyInput&&this.apiKeyInput.setAttribute("aria-label","Gemini API Key"),this.darkModeToggle&&this.darkModeToggle.setAttribute("aria-label","Toggle dark mode"),this.darkModeToggle&&this.darkModeToggle.addEventListener("change",async s=>{this.isDarkMode=s.target.checked,document.body.classList.toggle("dark-mode",this.isDarkMode),await chrome.storage.local.set({darkMode:this.isDarkMode})}),document.addEventListener("keydown",s=>{(s.ctrlKey||s.metaKey)&&s.key.toLowerCase()==="i"&&(s.preventDefault(),this.messageInput&&this.messageInput.focus())}),this.formatButtons.forEach(s=>{s.addEventListener("click",d=>{d.preventDefault(),s.id==="clear-chat-button"?this.handleClearChat():s.id==="export-chat-button"?this.handleExportChat():this.handleFormatting(s.getAttribute("title").toLowerCase())})}),this.quickTwitterBtn&&this.quickTwitterBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSocialContent("twitter")}),this.quickThreadBtn&&this.quickThreadBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSocialContent("thread")});let k=document.getElementById("quick-blog");k&&k.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSpecialContent("blog")});let E=document.getElementById("quick-summary");E&&E.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSpecialContent("summary")});let I=document.getElementById("quick-keypoints");I&&I.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSpecialContent("keypoints")});let f=document.getElementById("quick-factcheck");f&&f.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSpecialContent("factcheck")});let T=document.getElementById("quick-analysis");T&&T.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSpecialContent("analysis")}),this.initializeHorizontalScroll()}async testApiKey(t){try{let e=await chrome.runtime.sendMessage({action:"testApiKey",apiKey:t});return e&&e.success}catch(e){return console.error("Error testing API key:",e),!1}}async handleSaveSettings(){let t=this.apiKeyInput?this.apiKeyInput.value.trim():"";if(!t){alert("Please enter a valid API key");return}await this.testApiKey(t)?(await this.saveApiKey(t),console.log("TabTalk AI: Saving API key with key name 'geminiApiKey' successfully"),this.showView("chat"),await this.getAndCachePageContent()):alert("Invalid API key. Please try again.")}async getAndCachePageContent(){if(!(!this.currentTab||!this.apiKey)){this.setLoading(!0,"Reading page..."),this.pageStatus.textContent="Injecting script to read page...";try{if(this.currentTab.url?.startsWith("chrome://")||this.currentTab.url?.startsWith("https://chrome.google.com/webstore"))throw new Error("Cannot run on protected browser pages.");let t=await chrome.scripting.executeScript({target:{tabId:this.currentTab.id},files:["content.js"]});if(!t||t.length===0)throw new Error("Script injection failed.");let e=t[0].result;if(e.success)this.pageContent=e.content,this.pageStatus.textContent=`\u2705 Content loaded (${(e.content.length/1024).toFixed(1)} KB)`,this.updateQuickActionsVisibility();else throw new Error(e.error)}catch(t){console.error("TabTalk AI (popup):",t),this.pageStatus.textContent=`\u274C ${t.message}`}finally{this.setLoading(!1)}}}async sendMessage(){if(!this.messageInput||this.isLoading||!this.messageInput.value.trim())return;let t=this.messageInput.value.trim();this.messageInput.value="",this.handleInputChange(),this.messageInput.focus();try{this.setLoading(!0,"Sending message..."),this.addMessage("user",t),this.messagesContainer.scrollTo({top:this.messagesContainer.scrollHeight,behavior:"smooth"});let e=await this.callGeminiAPI(t);e&&(this.addMessage("assistant",e),this.messagesContainer.scrollTo({top:this.messagesContainer.scrollHeight,behavior:"smooth"}))}catch(e){console.error("Error sending message:",e),this.setAriaStatus("Error sending message: "+e.message),this.addMessage("assistant","Sorry, there was an error processing your message. Please try again.")}finally{this.setLoading(!1)}}async handleRefresh(){this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none"),this.pageContent=null,this.chatHistory=[],await this.saveState(),this.updateViewState("status","Refreshing..."),await this.getAndCachePageContent(),this.renderMessages()}handleFormatting(t){let e=this.messageInput,a=e.selectionStart,n=e.selectionEnd,r=e.value,i="",l="";switch(t){case"bold":i="**",l="**";break;case"italic":i="_",l="_";break;case"code":r.substring(a,n).includes(`
`)?(i="```\n",l="\n```"):(i="`",l="`");break;case"link":a===n?(i="[",l="](url)"):(i="[",l="](https://)");break}let u=r.substring(0,a)+i+r.substring(a,n)+l+r.substring(n);e.value=u;let h=n+i.length;e.setSelectionRange(h,h+(a===n?0:n-a)),this.handleInputChange(),e.focus()}async handleClearChat(){confirm("Clear all chat history for this page?")&&(this.chatHistory=[],await this.saveState(),this.renderMessages())}async generateSpecialContent(t){if(!this.pageContent||!this.apiKey){alert("Please make sure you have set up your API key and the page content is loaded.");return}this.resetScreenForGeneration&&this.resetScreenForGeneration(),this.setLoading(!0,`Generating ${t}...`),this.showProgressBar&&this.showProgressBar(`Generating ${t}...`),console.log(`TabTalk AI: Generating ${t} for page: ${this.currentTab?.title}`);try{let e="",a="";switch(t){case"summary":e=`You are an expert summarizer. Produce a clean, copy-ready summary with NO prefaces (do NOT start with phrases like "Here's" or "Below is").
                    Strict rules:
                    - Output plain text or markdown only, no boilerplate, no disclaimers
                    - 1\u20132 short paragraphs, 100\u2013150 words total
                    - No markdown emphasis (** or _)
                    - No headings, no lists, no closing remarks
                    - Focus only on the core ideas
                    - Never include artifacts like (line break) or duplicated links`,a=`Create a concise 100\u2013150 word summary. No intro/outro lines, no filler words, no emphasis. Return only the final summary.

CONTENT:
${this.pageContent}`;break;case"keypoints":e=`You are an expert content analyst. Extract 5\u201310 clean key points.
                    Strict rules:
                    - Output ONLY a bullet list using hyphens ("- ") per line
                    - No preface like "Here are" or "Here's a list"; no headings; no intro/outro
                    - No markdown emphasis (** or _)
                    - Each bullet must be a single, complete idea; no run-on sentences
                    - No extra blank lines, no numbering
                    - No artifacts like (line break) or duplicated links`,a=`Return ONLY hyphen bullets with the key points. No extra text above or below.

CONTENT:
${this.pageContent}`;break;case"analysis":e=`You are an expert content analyst. Provide an in-depth analysis.
                    Strict rules:
                    - Use markdown headings for sections: Overview, Main Themes, Evidence Quality, Perspective, Context, Strengths & Weaknesses, Implications, Conclusion
                    - No preface or filler like "Here is"; start directly with the first heading
                    - Be specific and cite details from the content; avoid generic phrases
                    - Keep paragraphs short and scannable
                    - No duplicated links or artifacts`,a=`Write a structured analysis with the exact headings above. Start immediately with "## Overview".

CONTENT:
${this.pageContent}`;break;case"faq":e=`You are an expert FAQ creator. Generate 5\u20138 Q&A pairs.
                    Strict rules:
                    - Output as markdown: "### Q: ..." then an answer paragraph
                    - No preface or intro sections
                    - Keep Q precise and Answer concrete
                    - Use bullets in answers only if necessary, with hyphens
                    - No artifacts or duplicated links`,a=`Return ONLY the Q&A in the markdown format described.

CONTENT:
${this.pageContent}`;break;case"factcheck":e=`You are an expert fact-checker. Identify 5\u201310 factual claims and assess them.
                    Strict rules:
                    - Start directly with "Claim 1:" (no preface)
                    - For each claim include: Claim, Verifiability, Evidence (if any), Consistency, Confidence (High/Medium/Low), Notes
                    - Use concise bullets with hyphens under each claim heading
                    - No duplicated links or artifacts`,a=`Write the fact-check starting with "Claim 1:" and continue incrementally.

CONTENT:
${this.pageContent}`;break;case"blog":e=`You are an expert blog writer. Produce a clean, engaging blog post.
                    Strict rules:
                    - Use markdown: H1 title, then H2 sections
                    - No preface; start directly with the H1 title
                    - Short paragraphs, clear transitions
                    - No duplicated links or artifacts
                    - Aim 500\u2013800 words`,a=`Write the blog post now. Begin with "# " title line.

CONTENT:
${this.pageContent}`;break;default:throw new Error("Unknown content type")}console.log(`TabTalk AI: Calling API for ${t} with prompt length: ${e.length+a.length} characters`);let n=await this.callGeminiAPIWithSystemPrompt(e,a);if(n){if(console.log(`TabTalk AI: Successfully generated ${t}, response length: ${n.length} characters`),this.renderStructuredContent&&this.renderStructuredContent(t,n),this.addToHistory){let r={timestamp:new Date().toISOString(),url:this.currentTab?.url||"",title:this.currentTab?.title||"",domain:this.currentDomain||"",content:n,type:t};await this.addToHistory(t,r)}}else throw new Error("Empty response received from API")}catch(e){console.error(`Error generating ${t}:`,e),this.addMessage("assistant",`Sorry, there was an error generating the ${t}: ${e.message}`)}finally{this.setLoading(!1),this.hideProgressBar&&this.hideProgressBar()}}addFormattedMessage(t,e,a){console.log(`TabTalk AI: Adding formatted message of type ${a}, length: ${e.length}`);let n=new Date().toISOString(),r=e,i="";switch(a){case"summary":i=`\u{1F4DD} **Summary of This Page**

`;break;case"keypoints":i=`\u{1F511} **Key Points from This Page**

`;break;case"analysis":i=`\u{1F4CA} **Analysis Report of This Page** <span class="pdf-export-button" title="Export as PDF">\u2B07\uFE0F</span>

`;break;case"faq":i=`\u2753 **Frequently Asked Questions**

`;break;case"factcheck":i=`\u2705 **Fact Check Report**

`;break;default:break}this.chatHistory.push({role:t,content:i+r,timestamp:n,contentType:a}),console.log(`TabTalk AI: Added formatted message to chat history. Total messages: ${this.chatHistory.length}`),this.renderMessages(),this.saveState()}};window.TabTalkAPI&&Object.assign(c.prototype,window.TabTalkAPI),window.TabTalkExport&&Object.assign(c.prototype,window.TabTalkExport),window.TabTalkTwitter&&Object.assign(c.prototype,window.TabTalkTwitter),window.TabTalkStorage&&Object.assign(c.prototype,window.TabTalkStorage),window.TabTalkUI&&Object.assign(c.prototype,window.TabTalkUI),window.TabTalkScroll&&Object.assign(c.prototype,window.TabTalkScroll),window.TabTalkNavigation&&Object.assign(c.prototype,window.TabTalkNavigation),document.addEventListener("DOMContentLoaded",()=>{new c().init().catch(t=>console.error("Initialization error:",t))})})();})();
