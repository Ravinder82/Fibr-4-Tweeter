(()=>{var p=class{constructor(e="extension"){this.environment=e}async saveApiKey(e){if(this.environment==="extension")return chrome.storage.local.set({geminiApiKey:e,apiKeySet:!0});localStorage.setItem("tabtalk_api_key",e),localStorage.setItem("apiKeySet","true")}async loadApiKey(){return this.environment==="extension"?(await chrome.storage.local.get(["geminiApiKey"])).geminiApiKey||null:localStorage.getItem("tabtalk_api_key")||null}async saveChatHistory(e,t){let s=`chatHistory_${e}`;if(this.environment==="extension")return chrome.storage.local.set({[s]:t});localStorage.setItem(s,JSON.stringify(t))}async loadChatHistory(e){let t=`chatHistory_${e}`;if(this.environment==="extension")return(await chrome.storage.local.get([t]))[t]||[];{let s=localStorage.getItem(t);return s?JSON.parse(s):[]}}async saveSetting(e,t){if(this.environment==="extension")return chrome.storage.local.set({[e]:t});localStorage.setItem(e,JSON.stringify(t))}async loadSetting(e,t=null){if(this.environment==="extension"){let s=await chrome.storage.local.get([e]);return s[e]!==void 0?s[e]:t}else{let s=localStorage.getItem(e);return s!==null?JSON.parse(s):t}}async clearAll(){if(this.environment==="extension")return chrome.storage.local.clear();localStorage.clear()}async deleteApiKey(){if(this.environment==="extension")return chrome.storage.local.remove(["geminiApiKey","apiKeySet"]);localStorage.removeItem("tabtalk_api_key"),localStorage.removeItem("apiKeySet")}};var y=class{constructor(e="extension"){this.environment=e,this.storage=new p(e),this.state={apiKey:null,chatHistory:[],currentDomain:null,isDarkMode:!1,isLoading:!1}}async loadState(){if(this.state.apiKey=await this.storage.loadApiKey(),this.state.isDarkMode=await this.storage.loadSetting("darkMode",!1),this.environment==="extension"){let[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e&&(this.state.currentDomain=new URL(e.url).hostname)}return this.state.currentDomain&&(this.state.chatHistory=await this.storage.loadChatHistory(this.state.currentDomain)),this.state}async saveState(){this.state.apiKey&&await this.storage.saveApiKey(this.state.apiKey),await this.storage.saveSetting("darkMode",this.state.isDarkMode),this.state.currentDomain&&this.state.chatHistory.length>0&&await this.storage.saveChatHistory(this.state.currentDomain,this.state.chatHistory)}async deleteApiKey(){await this.storage.deleteApiKey(),this.state.apiKey=null}updateApiKey(e){this.state.apiKey=e}updateChatHistory(e){this.state.chatHistory=e}updateCurrentDomain(e){this.state.currentDomain=e}toggleDarkMode(){this.state.isDarkMode=!this.state.isDarkMode}setLoading(e){this.state.isLoading=e}getState(){return{...this.state}}};var m=class{constructor(e,t="extension"){this.apiKey=e,this.environment=t,this.baseURL="https://generativelanguage.googleapis.com/v1beta/models/",this.model="gemini-2.0-flash"}async generateContent(e,t={}){let s=[{role:"user",parts:[{text:e}]}];return this.callAPI({contents:s})}async callAPI(e){return this.environment==="extension"?this.callViaBackground(e):this.callDirect(e)}async callViaBackground(e){try{let t=await chrome.runtime.sendMessage({action:"callGeminiAPI",payload:e,apiKey:this.apiKey});if(t.success&&t.data?.candidates?.[0]?.content?.parts?.[0]?.text)return t.data.candidates[0].content.parts[0].text;throw new Error(t.error||"The AI gave an empty or invalid response.")}catch(t){throw new Error(`API Error: ${t.message}`)}}async callDirect(e){let t=`${this.baseURL}${this.model}:generateContent?key=${this.apiKey}`;try{let s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await s.text();if(!s.ok){let c=`API request failed (Status: ${s.status}).`;try{let r=JSON.parse(n);r?.error?.message&&(c=`API Error: ${r.error.message}`)}catch{c+=` Details: ${n.substring(0,150)}...`}throw new Error(c)}let a=JSON.parse(n);if(a?.candidates?.[0]?.content?.parts?.[0]?.text)return a.candidates[0].content.parts[0].text;throw new Error("The AI gave an empty or invalid response.")}catch(s){throw new Error(`Network Error: ${s.message}`)}}};var E=class{constructor(e=null){this.marked=e,this.marked&&this.marked.setOptions({gfm:!0,breaks:!0,sanitize:!0})}renderMessage(e){let t=document.createElement("div");t.classList.add("message",e.role,"visible"),e.contentType&&t.classList.add(`${e.contentType}-message`);let s=document.createElement("div");s.classList.add("message-header");let n=document.createElement("div");if(n.classList.add("avatar"),e.role==="user")n.textContent="\u{1F464}";else switch(e.contentType){case"summary":n.textContent="\u{1F4DD}";break;case"keypoints":n.textContent="\u{1F511}";break;case"analysis":n.textContent="\u{1F4CA}";break;case"faq":n.textContent="\u2753";break;case"factcheck":n.textContent="\u2705";break;default:n.textContent="\u{1F916}"}let a=document.createElement("div");a.classList.add("timestamp");let c=e.timestamp||new Date().toISOString();a.textContent=new Date(c).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),e.role==="user"?(s.appendChild(a),s.appendChild(n)):(s.appendChild(n),s.appendChild(a));let r=document.createElement("div");if(r.classList.add("content"),this.marked&&e.content?r.innerHTML=this.marked.parse(e.content):r.textContent=e.content||"",e.role==="assistant"){let d=document.createElement("button");d.classList.add("copy-button"),d.innerHTML="\u{1F4CB}",d.title="Copy to clipboard",d.addEventListener("click",()=>{navigator.clipboard.writeText(e.content).then(()=>{let g=d.innerHTML;d.innerHTML="\u2713",setTimeout(()=>{d.innerHTML=g},2e3)})}),r.appendChild(d)}return t.appendChild(s),t.appendChild(r),t}formatSpecialContent(e,t){return e}};var o={SUMMARY:"summary",KEYPOINTS:"keypoints",ANALYSIS:"analysis",FAQ:"faq",FACTCHECK:"factcheck"};var u={INITIALIZING:"Initializing...",LOADING_PAGE:"Reading page...",SENDING_MESSAGE:"Sending message...",DONE:"\u2705 Done",ERROR_PREFIX:"\u274C "},A={[o.SUMMARY]:{system:"You are an expert content summarizer. Create a concise summary of the provided webpage content. Focus on the main points and key information. Keep it under 200 words.",user:"Please provide a summary of this webpage content:"},[o.KEYPOINTS]:{system:"You are a key point extractor. Identify and list the most important points from the provided content. Number each point and keep them brief but informative. Limit to 5-7 key points.",user:"Please extract the key points from this content:"},[o.ANALYSIS]:{system:"You are a content analyst. Provide a detailed analysis of the provided webpage content. Include main themes, important facts, potential implications, and your expert insights. Structure your response with clear headings.",user:"Please analyze this content in detail:"},[o.FAQ]:{system:"You are a FAQ generator. Based on the provided content, create 5-8 frequently asked questions and their answers. Make the questions relevant to readers who want to understand the content better.",user:"Please generate a FAQ based on this content:"},[o.FACTCHECK]:{system:"You are a fact-checker. Identify any claims, statistics, or statements in the provided content that could be verified. For each, indicate whether it can be confirmed, disputed, or is unverifiable, and explain why.",user:"Please fact-check this content:"}};function S(l,e=2){if(l===0)return"0 Bytes";let t=1024,s=e<0?0:e,n=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(l)/Math.log(t));return parseFloat((l/Math.pow(t,a)).toFixed(s))+" "+n[a]}var f=class{constructor(){this.stateManager=new y("extension"),this.apiClient=null,this.messageRenderer=new E(marked),this.currentTab=null,this.pageContent=null,this.views={},this.domElements={},this.init=this.init.bind(this),this.bindEvents=this.bindEvents.bind(this),this.handleSaveSettings=this.handleSaveSettings.bind(this),this.getAndCachePageContent=this.getAndCachePageContent.bind(this),this.sendMessage=this.sendMessage.bind(this),this.generateSpecialContent=this.generateSpecialContent.bind(this)}async init(){this.cacheDOMElements(),this.bindEvents(),this.updateViewState("status",u.INITIALIZING);try{let[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e){this.updateViewState("status","No active tab found.");return}this.currentTab=e,this.domElements.pageTitle&&(this.domElements.pageTitle.textContent=this.currentTab.title||"Untitled Page"),await this.stateManager.loadState();let t=this.stateManager.getState();t.apiKey?(this.apiClient=new m(t.apiKey,"extension"),this.updateViewState("chat"),await this.getAndCachePageContent()):this.updateViewState("settings")}catch(e){console.error("Initialization failed:",e),this.updateViewState("status",`Error: ${e.message}`)}}cacheDOMElements(){this.views={settings:document.getElementById("settings-view"),chat:document.getElementById("chat-view"),status:document.getElementById("status-view")},this.domElements={apiKeyInput:document.getElementById("api-key-input"),messagesContainer:document.getElementById("messages-container"),messageInput:document.getElementById("message-input"),sendButton:document.getElementById("send-button"),statusText:document.getElementById("status-text"),pageTitle:document.getElementById("page-title"),pageStatus:document.getElementById("page-status"),menuButton:document.getElementById("menu-button"),sidebar:document.getElementById("sidebar"),exportChatButton:document.getElementById("export-chat-button"),quickActions:document.getElementById("quick-actions"),darkModeToggle:document.getElementById("dark-mode-toggle"),deleteApiKeyButton:document.getElementById("delete-api-key-button")}}bindEvents(){let e=document.getElementById("settings-cancel-button"),t=document.getElementById("settings-save-button"),s=document.getElementById("delete-api-key-button");e&&e.addEventListener("click",()=>{let i=this.stateManager.getState();this.updateViewState(i.apiKey?"chat":"settings")}),t&&t.addEventListener("click",this.handleSaveSettings),s&&s.addEventListener("click",()=>this.handleDeleteApiKey()),this.domElements.menuButton&&this.domElements.sidebar&&(this.domElements.menuButton.addEventListener("click",i=>{i.stopPropagation();let h=this.domElements.sidebar.classList.contains("hidden");h?(this.domElements.sidebar.classList.remove("hidden"),this.domElements.sidebar.style.display="block"):(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.style.display="none"),this.domElements.sidebar.setAttribute("aria-expanded",h?"false":"true")}),document.addEventListener("click",i=>{this.domElements.sidebar.classList.contains("hidden")||!this.domElements.sidebar.contains(i.target)&&i.target!==this.domElements.menuButton&&(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.setAttribute("aria-expanded","false"))}),this.domElements.sidebar.addEventListener("keydown",i=>{i.key==="Escape"&&(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.setAttribute("aria-expanded","false"),this.domElements.menuButton.focus())}));let n=document.getElementById("menu-settings-link");n&&n.addEventListener("click",i=>{i.preventDefault(),this.updateViewState("settings"),this.domElements.sidebar&&this.domElements.sidebar.classList.add("hidden")});let a=document.getElementById("menu-refresh-link");a&&a.addEventListener("click",async i=>{i.preventDefault(),confirm("Clear all chat history for this page?")&&(this.stateManager.updateChatHistory([]),await this.stateManager.saveState(),this.renderMessages()),this.domElements.sidebar&&(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.style.display="none")}),[{id:"menu-summary-link",type:o.SUMMARY},{id:"menu-keypoints-link",type:o.KEYPOINTS},{id:"menu-analysis-link",type:o.ANALYSIS},{id:"menu-faq-link",type:o.FAQ},{id:"menu-factcheck-link",type:o.FACTCHECK}].forEach(i=>{let h=document.getElementById(i.id);h&&h.addEventListener("click",async C=>{C.preventDefault(),await this.generateSpecialContent(i.type),this.domElements.sidebar&&(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.style.display="none")})});let r=document.getElementById("quick-summary");r&&r.addEventListener("click",async()=>{await this.generateSpecialContent(o.SUMMARY)});let d=document.getElementById("quick-keypoints");d&&d.addEventListener("click",async()=>{await this.generateSpecialContent(o.KEYPOINTS)}),this.domElements.darkModeToggle&&this.domElements.darkModeToggle.addEventListener("change",async i=>{this.stateManager.toggleDarkMode(),document.body.classList.toggle("dark-mode",this.stateManager.getState().isDarkMode),await this.stateManager.saveState()}),this.domElements.messageInput&&(this.domElements.messageInput.addEventListener("input",()=>this.handleInputChange()),this.domElements.messageInput.addEventListener("keydown",i=>this.handleKeyDown(i))),this.domElements.sendButton&&this.domElements.sendButton.addEventListener("click",this.sendMessage),this.domElements.exportChatButton&&this.domElements.exportChatButton.addEventListener("click",()=>this.handleExportChat());let g=document.getElementById("clear-chat-button");g&&g.addEventListener("click",()=>this.handleClearChat())}async handleSaveSettings(){let e=this.domElements.apiKeyInput.value.trim();if(!e){alert("Please enter a valid API key.");return}this.stateManager.updateApiKey(e),await this.stateManager.saveState(),this.apiClient=new m(e,"extension"),this.updateViewState("chat");let t=document.querySelector(".onboarding-info");t&&(t.style.display="none"),this.pageContent||await this.getAndCachePageContent()}async handleDeleteApiKey(){confirm("Are you sure you want to delete your API key? You will need to enter a new key to use TabTalk AI.")&&(await this.stateManager.deleteApiKey(),await this.stateManager.saveState(),this.domElements.apiKeyInput&&(this.domElements.apiKeyInput.value=""),this.domElements.deleteApiKeyButton&&this.domElements.deleteApiKeyButton.classList.add("hidden"),this.updateViewState("settings"))}async getAndCachePageContent(){if(this.currentTab){this.setLoading(!0,u.LOADING_PAGE),this.domElements.pageStatus.textContent="Injecting script to read page...";try{let e=await chrome.scripting.executeScript({target:{tabId:this.currentTab.id},files:["content.js"]});if(e&&e[0]&&e[0].result&&e[0].result.success)this.pageContent=e[0].result.content,this.domElements.pageStatus.textContent=`\u2705 Content loaded (${S(this.pageContent.length)})`,this.updateQuickActionsVisibility();else throw new Error(e[0].result.error)}catch(e){console.error("TabTalk AI (popup):",e),this.domElements.pageStatus.textContent=`\u274C ${e.message}`}finally{this.setLoading(!1)}}}updateViewState(e,t="Loading..."){if(this.domElements.sidebar&&(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.style.display="none"),Object.values(this.views).forEach(s=>s.classList.add("hidden")),this.views[e]){if(this.views[e].classList.remove("hidden"),e==="chat"&&this.domElements.messageInput)this.domElements.messageInput.focus();else if(e==="settings"&&this.domElements.apiKeyInput){this.domElements.apiKeyInput.focus();let s=this.stateManager.getState();this.domElements.deleteApiKeyButton&&(s.apiKey?this.domElements.deleteApiKeyButton.classList.remove("hidden"):this.domElements.deleteApiKeyButton.classList.add("hidden"))}}else console.error(`View "${e}" not found`);if(e==="status"&&(this.domElements.statusText.textContent=t),e==="settings"){let s=document.querySelector(".onboarding-info");if(s){let n=this.stateManager.getState().apiKey;s.style.display=n?"none":"block"}}this.setAriaStatus(`Switched to ${e} view. ${t}`)}async sendMessage(){if(!this.domElements.messageInput||!this.apiClient||this.stateManager.getState().isLoading||!this.domElements.messageInput.value.trim())return;let e=this.domElements.messageInput.value.trim();this.domElements.messageInput.value="",this.handleInputChange(),this.domElements.messageInput.focus();try{this.setLoading(!0,u.SENDING_MESSAGE),this.addMessage("user",e),this.domElements.messagesContainer.scrollTo({top:this.domElements.messagesContainer.scrollHeight,behavior:"smooth"});let t=await this.apiClient.generateContent(`Page Content:
${this.pageContent}

User Question:
${e}`);t&&(this.addMessage("assistant",t),this.domElements.messagesContainer.scrollTo({top:this.domElements.messagesContainer.scrollHeight,behavior:"smooth"}))}catch(t){console.error("Error sending message:",t),this.setAriaStatus("Error sending message: "+t.message),this.addMessage("assistant","Sorry, there was an error processing your message. Please try again.")}finally{this.setLoading(!1)}}addMessage(e,t,s=null){let n=this.stateManager.getState(),a=new Date().toISOString(),c={role:e,content:t,contentType:s,timestamp:a},r=[...n.chatHistory,c];this.stateManager.updateChatHistory(r),this.stateManager.saveState(),this.renderMessages()}renderMessages(){let e=this.stateManager.getState();this.domElements.messagesContainer.innerHTML="",e.chatHistory.forEach(s=>{let n=this.messageRenderer.renderMessage(s);this.domElements.messagesContainer.appendChild(n)}),this.domElements.messagesContainer.scrollTo({top:this.domElements.messagesContainer.scrollHeight,behavior:"smooth"});let t=document.getElementById("empty-state");t&&(e.chatHistory.length===0?t.classList.remove("hidden"):t.classList.add("hidden")),this.updateQuickActionsVisibility()}setLoading(e,t="..."){this.stateManager.setLoading(e);let s=this.stateManager.getState();this.domElements.sendButton&&(this.domElements.sendButton.disabled=e||!this.domElements.messageInput?.value.trim()),this.domElements.messageInput&&(this.domElements.messageInput.disabled=e),e?(this.domElements.pageStatus.textContent=t,this.setAriaStatus(t)):(this.domElements.pageStatus.textContent.startsWith("\u2705")||(this.domElements.pageStatus.textContent=u.DONE),this.setAriaStatus("Ready"))}handleInputChange(){if(!this.domElements.messageInput)return;this.domElements.messageInput.style.height="auto";let e=Math.min(this.domElements.messageInput.scrollHeight,150);this.domElements.messageInput.style.height=`${e}px`;let t=document.querySelector(".char-count");if(t){let s=this.domElements.messageInput.value.length;t.textContent=`${s}/2000`,t.style.color=s>1800?"#ef4444":""}this.domElements.sendButton&&(this.domElements.sendButton.disabled=!this.domElements.messageInput.value.trim())}handleKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.domElements.messageInput&&this.domElements.messageInput.value.trim()&&this.domElements.sendButton&&!this.domElements.sendButton.disabled&&this.sendMessage())}async generateSpecialContent(e){if(this.apiClient){this.setLoading(!0,`Generating ${e}...`);try{if(!this.pageContent&&(this.domElements.pageStatus.textContent="\u26A0\uFE0F Re-analyzing page before generating content...",await this.getAndCachePageContent(),!this.pageContent))throw new Error("Could not get page content to generate content.");let s={[o.SUMMARY]:`Please provide a concise summary of the following webpage content:

${this.pageContent}`,[o.KEYPOINTS]:`Please extract 5-7 key points from the following content:

${this.pageContent}`,[o.ANALYSIS]:`Please provide a detailed analysis of the following content:

${this.pageContent}`,[o.FAQ]:`Please generate 5-8 frequently asked questions and answers based on the following content:

${this.pageContent}`,[o.FACTCHECK]:`Please fact-check the following content, identifying claims that can be verified:

${this.pageContent}`}[e];if(!s)throw new Error(`Unsupported content type: ${e}`);let n=await this.apiClient.generateContent(s);this.addMessage("assistant",n,e)}catch(t){console.error("Error generating special content:",t),this.addMessage("assistant",`Sorry, I couldn't generate the ${e}. Error: ${t.message}`)}finally{this.setLoading(!1)}}}updateQuickActionsVisibility(){if(!this.domElements.quickActions)return;let e=this.stateManager.getState();this.pageContent&&e.chatHistory.length===0?this.domElements.quickActions.classList.remove("hidden"):this.domElements.quickActions.classList.add("hidden")}handleExportChat(){let e=this.stateManager.getState();if(!e.chatHistory.length){alert("No chat history to export.");return}let t=JSON.stringify({chatHistory:e.chatHistory,exportedAt:new Date().toISOString(),pageUrl:this.currentTab?.url,pageTitle:this.currentTab?.title},null,2),s="data:application/json;charset=utf-8,"+encodeURIComponent(t),n=`tabtalk-chat-${new Date().toISOString().slice(0,10)}.json`,a=document.createElement("a");a.setAttribute("href",s),a.setAttribute("download",n),a.click()}handleClearChat(){confirm("Clear all chat history for this page?")&&(this.stateManager.updateChatHistory([]),this.stateManager.saveState(),this.renderMessages())}setAriaStatus(e){let t=document.getElementById("aria-status");t&&(t.textContent=e)}};document.addEventListener("DOMContentLoaded",()=>{new f().init()});})();
