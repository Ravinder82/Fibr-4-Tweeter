(()=>{var u=class{constructor(t="extension"){this.environment=t}async saveApiKey(t){if(this.environment==="extension")return chrome.storage.local.set({geminiApiKey:t,apiKeySet:!0});localStorage.setItem("tabtalk_api_key",t),localStorage.setItem("apiKeySet","true")}async loadApiKey(){return this.environment==="extension"?(await chrome.storage.local.get(["geminiApiKey"])).geminiApiKey||null:localStorage.getItem("tabtalk_api_key")||null}async saveChatHistory(t,e){let s=`chatHistory_${t}`;if(this.environment==="extension")return chrome.storage.local.set({[s]:e});localStorage.setItem(s,JSON.stringify(e))}async loadChatHistory(t){let e=`chatHistory_${t}`;if(this.environment==="extension")return(await chrome.storage.local.get([e]))[e]||[];{let s=localStorage.getItem(e);return s?JSON.parse(s):[]}}async saveSetting(t,e){if(this.environment==="extension")return chrome.storage.local.set({[t]:e});localStorage.setItem(t,JSON.stringify(e))}async loadSetting(t,e=null){if(this.environment==="extension"){let s=await chrome.storage.local.get([t]);return s[t]!==void 0?s[t]:e}else{let s=localStorage.getItem(t);return s!==null?JSON.parse(s):e}}async clearAll(){if(this.environment==="extension")return chrome.storage.local.clear();localStorage.clear()}};var g=class{constructor(t="extension"){this.environment=t,this.storage=new u(t),this.state={apiKey:null,chatHistory:[],currentDomain:null,isDarkMode:!1,isLoading:!1}}async loadState(){if(this.state.apiKey=await this.storage.loadApiKey(),this.state.isDarkMode=await this.storage.loadSetting("darkMode",!1),this.environment==="extension"){let[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t&&(this.state.currentDomain=new URL(t.url).hostname)}return this.state.currentDomain&&(this.state.chatHistory=await this.storage.loadChatHistory(this.state.currentDomain)),this.state}async saveState(){this.state.apiKey&&await this.storage.saveApiKey(this.state.apiKey),await this.storage.saveSetting("darkMode",this.state.isDarkMode),this.state.currentDomain&&this.state.chatHistory.length>0&&await this.storage.saveChatHistory(this.state.currentDomain,this.state.chatHistory)}updateApiKey(t){this.state.apiKey=t}updateChatHistory(t){this.state.chatHistory=t}updateCurrentDomain(t){this.state.currentDomain=t}toggleDarkMode(){this.state.isDarkMode=!this.state.isDarkMode}setLoading(t){this.state.isLoading=t}getState(){return{...this.state}}};var h=class{constructor(t,e="extension"){this.apiKey=t,this.environment=e,this.baseURL="https://generativelanguage.googleapis.com/v1beta/models/",this.model="gemini-2.0-flash"}async generateContent(t,e={}){let s=[{role:"user",parts:[{text:t}]}];return this.callAPI({contents:s})}async callAPI(t){return this.environment==="extension"?this.callViaBackground(t):this.callDirect(t)}async callViaBackground(t){try{let e=await chrome.runtime.sendMessage({action:"callGeminiAPI",payload:t,apiKey:this.apiKey});if(e.success&&e.data?.candidates?.[0]?.content?.parts?.[0]?.text)return e.data.candidates[0].content.parts[0].text;throw new Error(e.error||"The AI gave an empty or invalid response.")}catch(e){throw new Error(`API Error: ${e.message}`)}}async callDirect(t){let e=`${this.baseURL}${this.model}:generateContent?key=${this.apiKey}`;try{let s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=await s.text();if(!s.ok){let d=`API request failed (Status: ${s.status}).`;try{let r=JSON.parse(n);r?.error?.message&&(d=`API Error: ${r.error.message}`)}catch{d+=` Details: ${n.substring(0,150)}...`}throw new Error(d)}let o=JSON.parse(n);if(o?.candidates?.[0]?.content?.parts?.[0]?.text)return o.candidates[0].content.parts[0].text;throw new Error("The AI gave an empty or invalid response.")}catch(s){throw new Error(`Network Error: ${s.message}`)}}};var p=class{constructor(t=null){this.marked=t,this.marked&&this.marked.setOptions({gfm:!0,breaks:!0,sanitize:!0})}renderMessage(t){let e=document.createElement("div");e.classList.add("message",t.role,"visible");let s=document.createElement("div");s.classList.add("message-header");let n=document.createElement("div");n.classList.add("avatar"),t.role==="user"?n.textContent="\u{1F464}":t.contentType==="summary"?n.textContent="\u{1F4DD}":t.contentType==="keypoints"?n.textContent="\u{1F511}":t.contentType==="analysis"?n.textContent="\u{1F4CA}":t.contentType==="faq"?n.textContent="\u2753":t.contentType==="factcheck"?n.textContent="\u2705":n.textContent="\u{1F916}";let o=document.createElement("div");o.classList.add("timestamp");let d=t.timestamp||new Date().toISOString();o.textContent=new Date(d).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),t.role==="user"?(s.appendChild(o),s.appendChild(n)):(s.appendChild(n),s.appendChild(o));let r=document.createElement("div");return r.classList.add("content"),this.marked&&t.content?r.innerHTML=this.marked.parse(t.content):r.textContent=t.content||"",e.appendChild(s),e.appendChild(r),e}formatSpecialContent(t,e){return t}};var i={SUMMARY:"summary",KEYPOINTS:"keypoints",ANALYSIS:"analysis",FAQ:"faq",FACTCHECK:"factcheck"};var m={INITIALIZING:"Initializing...",LOADING_PAGE:"Reading page...",SENDING_MESSAGE:"Sending message...",DONE:"\u2705 Done",ERROR_PREFIX:"\u274C "},k={[i.SUMMARY]:{system:"You are an expert content summarizer. Create a concise summary of the provided webpage content. Focus on the main points and key information. Keep it under 200 words.",user:"Please provide a summary of this webpage content:"},[i.KEYPOINTS]:{system:"You are a key point extractor. Identify and list the most important points from the provided content. Number each point and keep them brief but informative. Limit to 5-7 key points.",user:"Please extract the key points from this content:"},[i.ANALYSIS]:{system:"You are a content analyst. Provide a detailed analysis of the provided webpage content. Include main themes, important facts, potential implications, and your expert insights. Structure your response with clear headings.",user:"Please analyze this content in detail:"},[i.FAQ]:{system:"You are a FAQ generator. Based on the provided content, create 5-8 frequently asked questions and their answers. Make the questions relevant to readers who want to understand the content better.",user:"Please generate a FAQ based on this content:"},[i.FACTCHECK]:{system:"You are a fact-checker. Identify any claims, statistics, or statements in the provided content that could be verified. For each, indicate whether it can be confirmed, disputed, or is unverifiable, and explain why.",user:"Please fact-check this content:"}};function f(l,t=2){if(l===0)return"0 Bytes";let e=1024,s=t<0?0:t,n=["Bytes","KB","MB","GB"],o=Math.floor(Math.log(l)/Math.log(e));return parseFloat((l/Math.pow(e,o)).toFixed(s))+" "+n[o]}var y=class{constructor(){this.stateManager=new g("extension"),this.apiClient=null,this.messageRenderer=new p(marked),this.currentTab=null,this.pageContent=null,this.views={},this.domElements={},this.init=this.init.bind(this),this.bindEvents=this.bindEvents.bind(this),this.handleSaveSettings=this.handleSaveSettings.bind(this),this.getAndCachePageContent=this.getAndCachePageContent.bind(this),this.sendMessage=this.sendMessage.bind(this),this.generateSpecialContent=this.generateSpecialContent.bind(this)}async init(){this.cacheDOMElements(),this.bindEvents(),this.updateViewState("status",m.INITIALIZING);try{let[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t){this.updateViewState("status","No active tab found.");return}this.currentTab=t,this.domElements.pageTitle&&(this.domElements.pageTitle.textContent=this.currentTab.title||"Untitled Page"),await this.stateManager.loadState();let e=this.stateManager.getState();e.apiKey?(this.apiClient=new h(e.apiKey,"extension"),this.updateViewState("chat"),await this.getAndCachePageContent()):this.updateViewState("settings")}catch(t){console.error("Initialization failed:",t),this.updateViewState("status",`Error: ${t.message}`)}}cacheDOMElements(){this.views={settings:document.getElementById("settings-view"),chat:document.getElementById("chat-view"),status:document.getElementById("status-view")},this.domElements={apiKeyInput:document.getElementById("api-key-input"),messagesContainer:document.getElementById("messages-container"),messageInput:document.getElementById("message-input"),sendButton:document.getElementById("send-button"),statusText:document.getElementById("status-text"),pageTitle:document.getElementById("page-title"),pageStatus:document.getElementById("page-status"),menuButton:document.getElementById("menu-button"),sidebar:document.getElementById("sidebar"),exportChatButton:document.getElementById("export-chat-button"),quickActions:document.getElementById("quick-actions"),darkModeToggle:document.getElementById("dark-mode-toggle")}}bindEvents(){let t=document.getElementById("settings-cancel-button"),e=document.getElementById("settings-save-button");t&&t.addEventListener("click",()=>{let a=this.stateManager.getState();this.updateViewState(a.apiKey?"chat":"settings")}),e&&e.addEventListener("click",this.handleSaveSettings),this.domElements.menuButton&&this.domElements.sidebar&&(this.domElements.menuButton.addEventListener("click",a=>{a.stopPropagation();let c=this.domElements.sidebar.classList.contains("hidden");c?(this.domElements.sidebar.classList.remove("hidden"),this.domElements.sidebar.style.display="block"):(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.style.display="none"),this.domElements.sidebar.setAttribute("aria-expanded",c?"false":"true")}),document.addEventListener("click",a=>{this.domElements.sidebar.classList.contains("hidden")||!this.domElements.sidebar.contains(a.target)&&a.target!==this.domElements.menuButton&&(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.setAttribute("aria-expanded","false"))}),this.domElements.sidebar.addEventListener("keydown",a=>{a.key==="Escape"&&(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.setAttribute("aria-expanded","false"),this.domElements.menuButton.focus())}));let s=document.getElementById("menu-settings-link");s&&s.addEventListener("click",a=>{a.preventDefault(),this.updateViewState("settings"),this.domElements.sidebar&&this.domElements.sidebar.classList.add("hidden")});let n=document.getElementById("menu-refresh-link");n&&n.addEventListener("click",async a=>{a.preventDefault(),confirm("Clear all chat history for this page?")&&(this.stateManager.updateChatHistory([]),await this.stateManager.saveState(),this.renderMessages()),this.domElements.sidebar&&(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.style.display="none")}),[{id:"menu-summary-link",type:i.SUMMARY},{id:"menu-keypoints-link",type:i.KEYPOINTS},{id:"menu-analysis-link",type:i.ANALYSIS},{id:"menu-faq-link",type:i.FAQ},{id:"menu-factcheck-link",type:i.FACTCHECK}].forEach(a=>{let c=document.getElementById(a.id);c&&c.addEventListener("click",async S=>{S.preventDefault(),await this.generateSpecialContent(a.type),this.domElements.sidebar&&(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.style.display="none")})});let d=document.getElementById("quick-summary");d&&d.addEventListener("click",async()=>{await this.generateSpecialContent(i.SUMMARY)});let r=document.getElementById("quick-keypoints");r&&r.addEventListener("click",async()=>{await this.generateSpecialContent(i.KEYPOINTS)}),this.domElements.darkModeToggle&&this.domElements.darkModeToggle.addEventListener("change",async a=>{this.stateManager.toggleDarkMode(),document.body.classList.toggle("dark-mode",this.stateManager.getState().isDarkMode),await this.stateManager.saveState()}),this.domElements.messageInput&&(this.domElements.messageInput.addEventListener("input",()=>this.handleInputChange()),this.domElements.messageInput.addEventListener("keydown",a=>this.handleKeyDown(a))),this.domElements.sendButton&&this.domElements.sendButton.addEventListener("click",this.sendMessage),this.domElements.exportChatButton&&this.domElements.exportChatButton.addEventListener("click",()=>this.handleExportChat());let E=document.getElementById("clear-chat-button");E&&E.addEventListener("click",()=>this.handleClearChat())}async handleSaveSettings(){let t=this.domElements.apiKeyInput.value.trim();if(!t){alert("Please enter a valid API key.");return}this.stateManager.updateApiKey(t),await this.stateManager.saveState(),this.apiClient=new h(t,"extension"),this.updateViewState("chat");let e=document.querySelector(".onboarding-info");e&&(e.style.display="none"),this.pageContent||await this.getAndCachePageContent()}async getAndCachePageContent(){if(this.currentTab){this.setLoading(!0,m.LOADING_PAGE),this.domElements.pageStatus.textContent="Injecting script to read page...";try{let t=await chrome.scripting.executeScript({target:{tabId:this.currentTab.id},files:["content.js"]});if(t&&t[0]&&t[0].result&&t[0].result.success)this.pageContent=t[0].result.content,this.domElements.pageStatus.textContent=`\u2705 Content loaded (${f(this.pageContent.length)})`,this.updateQuickActionsVisibility();else throw new Error(t[0].result.error)}catch(t){console.error("TabTalk AI (popup):",t),this.domElements.pageStatus.textContent=`\u274C ${t.message}`}finally{this.setLoading(!1)}}}updateViewState(t,e="Loading..."){if(this.domElements.sidebar&&(this.domElements.sidebar.classList.add("hidden"),this.domElements.sidebar.style.display="none"),Object.values(this.views).forEach(s=>s.classList.add("hidden")),this.views[t]?(this.views[t].classList.remove("hidden"),t==="chat"&&this.domElements.messageInput?this.domElements.messageInput.focus():t==="settings"&&this.domElements.apiKeyInput&&this.domElements.apiKeyInput.focus()):console.error(`View "${t}" not found`),t==="status"&&(this.domElements.statusText.textContent=e),t==="settings"){let s=document.querySelector(".onboarding-info");if(s){let n=this.stateManager.getState().apiKey;s.style.display=n?"none":"block"}}this.setAriaStatus(`Switched to ${t} view. ${e}`)}async sendMessage(){if(!this.domElements.messageInput||!this.apiClient||this.stateManager.getState().isLoading||!this.domElements.messageInput.value.trim())return;let t=this.domElements.messageInput.value.trim();this.domElements.messageInput.value="",this.handleInputChange(),this.domElements.messageInput.focus();try{this.setLoading(!0,m.SENDING_MESSAGE),this.addMessage("user",t),this.domElements.messagesContainer.scrollTo({top:this.domElements.messagesContainer.scrollHeight,behavior:"smooth"});let e=await this.apiClient.generateContent(`Page Content:
${this.pageContent}

User Question:
${t}`);e&&(this.addMessage("assistant",e),this.domElements.messagesContainer.scrollTo({top:this.domElements.messagesContainer.scrollHeight,behavior:"smooth"}))}catch(e){console.error("Error sending message:",e),this.setAriaStatus("Error sending message: "+e.message),this.addMessage("assistant","Sorry, there was an error processing your message. Please try again.")}finally{this.setLoading(!1)}}addMessage(t,e,s=null){let n=this.stateManager.getState(),o=new Date().toISOString(),d={role:t,content:e,contentType:s,timestamp:o},r=[...n.chatHistory,d];this.stateManager.updateChatHistory(r),this.stateManager.saveState(),this.renderMessages()}renderMessages(){let t=this.stateManager.getState();this.domElements.messagesContainer.innerHTML="",t.chatHistory.forEach(e=>{let s=this.messageRenderer.renderMessage(e);this.domElements.messagesContainer.appendChild(s)}),this.domElements.messagesContainer.scrollTo({top:this.domElements.messagesContainer.scrollHeight,behavior:"smooth"}),this.updateQuickActionsVisibility()}setLoading(t,e="..."){this.stateManager.setLoading(t);let s=this.stateManager.getState();this.domElements.sendButton&&(this.domElements.sendButton.disabled=t||!this.domElements.messageInput?.value.trim()),this.domElements.messageInput&&(this.domElements.messageInput.disabled=t),t?(this.domElements.pageStatus.textContent=e,this.setAriaStatus(e)):(this.domElements.pageStatus.textContent.startsWith("\u2705")||(this.domElements.pageStatus.textContent=m.DONE),this.setAriaStatus("Ready"))}handleInputChange(){if(!this.domElements.messageInput)return;this.domElements.messageInput.style.height="auto";let t=Math.min(this.domElements.messageInput.scrollHeight,150);this.domElements.messageInput.style.height=`${t}px`;let e=document.querySelector(".char-count");if(e){let s=this.domElements.messageInput.value.length;e.textContent=`${s}/2000`,e.style.color=s>1800?"#ef4444":""}this.domElements.sendButton&&(this.domElements.sendButton.disabled=!this.domElements.messageInput.value.trim())}handleKeyDown(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.domElements.messageInput&&this.domElements.messageInput.value.trim()&&this.domElements.sendButton&&!this.domElements.sendButton.disabled&&this.sendMessage())}async generateSpecialContent(t){if(this.apiClient){this.setLoading(!0,`Generating ${t}...`);try{if(!this.pageContent&&(this.domElements.pageStatus.textContent="\u26A0\uFE0F Re-analyzing page before generating content...",await this.getAndCachePageContent(),!this.pageContent))throw new Error("Could not get page content to generate content.");let s={[i.SUMMARY]:`Please provide a concise summary of the following webpage content:

${this.pageContent}`,[i.KEYPOINTS]:`Please extract 5-7 key points from the following content:

${this.pageContent}`,[i.ANALYSIS]:`Please provide a detailed analysis of the following content:

${this.pageContent}`,[i.FAQ]:`Please generate 5-8 frequently asked questions and answers based on the following content:

${this.pageContent}`,[i.FACTCHECK]:`Please fact-check the following content, identifying claims that can be verified:

${this.pageContent}`}[t];if(!s)throw new Error(`Unsupported content type: ${t}`);let n=await this.apiClient.generateContent(s);this.addMessage("assistant",n,t)}catch(e){console.error("Error generating special content:",e),this.addMessage("assistant",`Sorry, I couldn't generate the ${t}. Error: ${e.message}`)}finally{this.setLoading(!1)}}}updateQuickActionsVisibility(){if(!this.domElements.quickActions)return;let t=this.stateManager.getState();this.pageContent&&t.chatHistory.length===0?this.domElements.quickActions.classList.remove("hidden"):this.domElements.quickActions.classList.add("hidden")}handleExportChat(){let t=this.stateManager.getState();if(!t.chatHistory.length){alert("No chat history to export.");return}let e=JSON.stringify({chatHistory:t.chatHistory,exportedAt:new Date().toISOString(),pageUrl:this.currentTab?.url,pageTitle:this.currentTab?.title},null,2),s="data:application/json;charset=utf-8,"+encodeURIComponent(e),n=`tabtalk-chat-${new Date().toISOString().slice(0,10)}.json`,o=document.createElement("a");o.setAttribute("href",s),o.setAttribute("download",n),o.click()}handleClearChat(){confirm("Clear all chat history for this page?")&&(this.stateManager.updateChatHistory([]),this.stateManager.saveState(),this.renderMessages())}setAriaStatus(t){let e=document.getElementById("aria-status");e&&(e.textContent=t)}};document.addEventListener("DOMContentLoaded",()=>{new y().init()});})();
