(()=>{(()=>{var r=class{constructor(){this.apiKey=null,this.currentTab=null,this.chatHistory=[],this.pageContent=null,this.isLoading=!1,this.currentDomain=null,this.maxCharCount=2e3,this.charCount=document.querySelector(".char-count"),this.formatButtons=document.querySelectorAll(".format-button, .tool-button"),this.inputBar=document.querySelector(".input-bar"),this.messageInput=document.getElementById("message-input"),this.sendButton=document.getElementById("send-button"),this.messagesContainer=document.getElementById("messages-container"),this.pageStatus=document.getElementById("page-status"),this.pageTitle=document.getElementById("page-title"),this.quickActions=document.getElementById("quick-actions"),this.sidebar=document.getElementById("sidebar"),this.quickTwitterBtn=document.getElementById("quick-twitter"),this.quickTldrBtn=document.getElementById("quick-tldr"),this.quickInsightsBtn=document.getElementById("quick-insights"),this.quickActionsBtn=document.getElementById("quick-actions-btn"),this.quickDiscussionBtn=document.getElementById("quick-discussion"),this.quickLinkedInBtn=document.getElementById("quick-linkedin"),this.quickEmailBtn=document.getElementById("quick-email"),this.welcomeView=document.getElementById("welcome-view"),this.apiSetupView=document.getElementById("api-setup-view"),this.chatView=document.getElementById("chat-view"),this.settingsView=document.getElementById("settings-view"),this.menuButton=document.getElementById("menu-button"),this.apiKeyInput=document.getElementById("api-key-input")||document.getElementById("settings-api-key"),this.inputActions=document.querySelector(".input-actions"),this.exportFormatSelect=document.getElementById("export-format-select"),this.statusText=document.getElementById("status-text"),this.views={welcome:this.welcomeView,"api-setup":this.apiSetupView,chat:this.chatView,settings:this.settingsView}}async init(){console.log("TabTalk AI: Initializing popup"),this.currentTab=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0],await this.loadState(),this.bindEvents();let i=await this.getStorageItem("hasSeenWelcome");this.apiKey?(this.showView("chat"),await this.getAndCachePageContent()):i?this.showView("api-setup"):this.showView("welcome"),console.log("TabTalk AI: Popup initialized")}bindEvents(){let i=document.getElementById("settings-cancel-button"),e=document.getElementById("settings-save-button");i&&i.addEventListener("click",()=>{this.updateViewState(this.apiKey?"chat":"settings")}),e&&e.addEventListener("click",()=>this.handleSaveSettings());let d=document.getElementById("delete-api-key-button");d&&d.addEventListener("click",()=>this.handleDeleteApiKey()),console.log("Menu Button:",this.menuButton),console.log("Sidebar:",this.sidebar),this.menuButton&&this.sidebar&&(this.menuButton.addEventListener("click",t=>{t.stopPropagation(),console.log("Menu button clicked!");let h=this.sidebar.classList.contains("hidden");h?(this.sidebar.classList.remove("hidden"),this.sidebar.style.display="block"):(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none"),console.log("Sidebar is now:",h?"visible":"hidden"),this.sidebar.setAttribute("aria-expanded",h?"false":"true")}),document.addEventListener("click",t=>{this.sidebar.classList.contains("hidden")||!this.sidebar.contains(t.target)&&t.target!==this.menuButton&&(this.sidebar.classList.add("hidden"),this.sidebar.setAttribute("aria-expanded","false"))}),this.sidebar.addEventListener("keydown",t=>{t.key==="Escape"&&(this.sidebar.classList.add("hidden"),this.sidebar.setAttribute("aria-expanded","false"),this.menuButton.focus())}));let s=document.getElementById("menu-settings-link");s&&s.addEventListener("click",t=>{t.preventDefault(),this.updateViewState("settings"),this.sidebar&&this.sidebar.classList.add("hidden")});let o=document.getElementById("menu-gallery-link");o&&o.addEventListener("click",t=>{t.preventDefault(),this.showView("gallery"),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")});let n=document.getElementById("menu-refresh-link");n&&n.addEventListener("click",async t=>{t.preventDefault(),confirm("Clear all chat history for this page?")&&(this.chatHistory=[],await this.saveState(),this.renderMessages()),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")});let a=document.getElementById("welcome-get-started");a&&a.addEventListener("click",async()=>{await this.setStorageItem("hasSeenWelcome",!0),this.showView("api-setup")});let g=document.getElementById("welcome-start");g&&g.addEventListener("click",async()=>{await this.setStorageItem("hasSeenWelcome",!0),this.showView("api-setup")});let l=document.getElementById("api-setup-back");l&&l.addEventListener("click",()=>{this.showView("welcome")});let u=document.getElementById("api-setup-back-arrow");u&&u.addEventListener("click",()=>{this.showView("welcome")});let b=document.getElementById("api-setup-continue");b&&b.addEventListener("click",async()=>{let t=document.getElementById("onboarding-api-key").value.trim();t&&(await this.saveApiKey(t),this.showView("chat"),await this.getAndCachePageContent())});let c=document.getElementById("test-api-key");c&&c.addEventListener("click",async()=>{let t=document.getElementById("onboarding-api-key").value.trim();if(t){let h=await this.testApiKey(t),k=document.getElementById("api-setup-continue");h?(c.textContent="\u2713 Valid",c.style.background="#10b981",c.style.color="white",k.disabled=!1):(c.textContent="\u2717 Invalid",c.style.background="#ef4444",c.style.color="white",k.disabled=!0),setTimeout(()=>{c.textContent="Test",c.style.background="",c.style.color=""},2e3)}});let w=document.getElementById("onboarding-api-key");w&&w.addEventListener("input",()=>{let t=document.getElementById("api-setup-continue");t.disabled=!w.value.trim()}),this.sendButton&&this.sendButton.addEventListener("click",()=>this.sendMessage()),this.messageInput&&(this.messageInput.addEventListener("input",()=>this.handleInputChange()),this.messageInput.addEventListener("keydown",t=>this.handleInputKeydown(t)),this.messageInput.addEventListener("focus",()=>{this.inputBar.classList.add("focused"),this.messageInput.setAttribute("aria-expanded","true")}),this.messageInput.addEventListener("blur",()=>{this.inputBar.classList.remove("focused"),this.messageInput.setAttribute("aria-expanded","false")}));let m=this.inputActions?this.inputActions.querySelector("#clear-chat-button"):document.getElementById("clear-chat-button");m&&m.addEventListener("click",async()=>{confirm("Clear all chat history for this page?")&&(this.chatHistory=[],await this.saveState(),this.renderMessages())});let y=this.inputActions?this.inputActions.querySelector("#export-chat-button"):document.getElementById("export-chat-button");y&&y.addEventListener("click",()=>this.handleExportChat());let p=this.inputActions?this.inputActions.querySelector("#export-format-select"):document.getElementById("export-format-select");p&&p.setAttribute("aria-label","Export format"),this.sendButton&&this.sendButton.setAttribute("aria-label","Send message"),m&&m.setAttribute("aria-label","Clear chat history"),y&&y.setAttribute("aria-label","Export chat"),p&&p.setAttribute("aria-label","Export format"),this.menuButton&&this.menuButton.setAttribute("aria-label","Open menu"),this.apiKeyInput&&this.apiKeyInput.setAttribute("aria-label","Gemini API Key"),document.addEventListener("keydown",t=>{(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="i"&&(t.preventDefault(),this.messageInput&&this.messageInput.focus())}),this.formatButtons.forEach(t=>{t.addEventListener("click",h=>{h.preventDefault(),t.id==="clear-chat-button"?this.handleClearChat():t.id==="export-chat-button"?this.handleExportChat():this.handleFormatting(t.getAttribute("title").toLowerCase())})}),this.quickTwitterBtn&&this.quickTwitterBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSocialContent("twitter")}),this.quickTldrBtn&&this.quickTldrBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSmartTLDR()}),this.quickInsightsBtn&&this.quickInsightsBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateKeyInsights()}),this.quickActionsBtn&&this.quickActionsBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateActionItems()}),this.quickDiscussionBtn&&this.quickDiscussionBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateDiscussionQuestions()}),this.quickLinkedInBtn&&this.quickLinkedInBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateLinkedInPost()}),this.quickEmailBtn&&this.quickEmailBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateEmailSummary("colleague")}),this.initializeHorizontalScroll()}async testApiKey(i){try{let e=await chrome.runtime.sendMessage({action:"testApiKey",apiKey:i});return e&&e.success}catch(e){return console.error("Error testing API key:",e),!1}}async handleSaveSettings(){let i=this.apiKeyInput?this.apiKeyInput.value.trim():"";if(!i){alert("Please enter a valid API key");return}await this.testApiKey(i)?(await this.saveApiKey(i),console.log("TabTalk AI: Saving API key with key name 'geminiApiKey' successfully"),this.showView("chat"),await this.getAndCachePageContent()):alert("Invalid API key. Please try again.")}async getAndCachePageContent(){if(!(!this.currentTab||!this.apiKey)){this.setLoading(!0,"Reading page..."),this.pageStatus.textContent="Injecting script to read page...";try{if(this.currentTab.url?.startsWith("chrome://")||this.currentTab.url?.startsWith("https://chrome.google.com/webstore"))throw new Error("Cannot run on protected browser pages.");let i=await chrome.scripting.executeScript({target:{tabId:this.currentTab.id},files:["content.js"]});if(!i||i.length===0)throw new Error("Script injection failed.");let e=i[0].result;if(e.success)this.pageContent=e.content,this.pageStatus.textContent=`\u2705 Content loaded (${(e.content.length/1024).toFixed(1)} KB)`,this.updateQuickActionsVisibility();else throw new Error(e.error)}catch(i){console.error("TabTalk AI (popup):",i),this.pageStatus.textContent=`\u274C ${i.message}`}finally{this.setLoading(!1)}}}async sendMessage(){if(!this.messageInput||this.isLoading||!this.messageInput.value.trim())return;let i=this.messageInput.value.trim();this.messageInput.value="",this.handleInputChange(),this.messageInput.focus();try{this.setLoading(!0,"Sending message..."),this.addMessage("user",i),this.messagesContainer.scrollTo({top:this.messagesContainer.scrollHeight,behavior:"smooth"});let e=await this.callGeminiAPI(i);e&&(this.addMessage("assistant",e),this.messagesContainer.scrollTo({top:this.messagesContainer.scrollHeight,behavior:"smooth"}))}catch(e){console.error("Error sending message:",e),this.setAriaStatus("Error sending message: "+e.message),this.addMessage("assistant","Sorry, there was an error processing your message. Please try again.")}finally{this.setLoading(!1)}}async handleRefresh(){this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none"),this.pageContent=null,this.chatHistory=[],await this.saveState(),this.updateViewState("status","Refreshing..."),await this.getAndCachePageContent(),this.renderMessages()}handleFormatting(i){let e=this.messageInput,d=e.selectionStart,s=e.selectionEnd,o=e.value,n="",a="";switch(i){case"bold":n="**",a="**";break;case"italic":n="_",a="_";break;case"code":o.substring(d,s).includes(`
`)?(n="```\n",a="\n```"):(n="`",a="`");break;case"link":d===s?(n="[",a="](url)"):(n="[",a="](https://)");break}let g=o.substring(0,d)+n+o.substring(d,s)+a+o.substring(s);e.value=g;let l=s+n.length;e.setSelectionRange(l,l+(d===s?0:s-d)),this.handleInputChange(),e.focus()}async handleClearChat(){confirm("Clear all chat history for this page?")&&(this.chatHistory=[],await this.saveState(),this.renderMessages())}};window.TabTalkAPI&&Object.assign(r.prototype,window.TabTalkAPI),window.TabTalkExport&&Object.assign(r.prototype,window.TabTalkExport),window.TabTalkTwitter&&Object.assign(r.prototype,window.TabTalkTwitter),window.TabTalkContentAnalysis&&Object.assign(r.prototype,window.TabTalkContentAnalysis),window.TabTalkSocialMedia&&Object.assign(r.prototype,window.TabTalkSocialMedia),window.TabTalkStorage&&Object.assign(r.prototype,window.TabTalkStorage),window.TabTalkUI&&Object.assign(r.prototype,window.TabTalkUI),window.TabTalkScroll&&Object.assign(r.prototype,window.TabTalkScroll),window.TabTalkNavigation&&Object.assign(r.prototype,window.TabTalkNavigation),r.prototype.initHistoryManager=function(){if(window.TabTalkStorage){window.historyManager=new HistoryManager(window.TabTalkStorage);let i=document.getElementById("sidebar");if(i){let s=document.createElement("a");s.href="#",s.id="menu-history-link",s.textContent="\u{1F4DA} Saved Content",s.addEventListener("click",()=>{this.showView("history"),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")}),i.appendChild(s)}let e=document.getElementById("history-back-btn");e&&e.addEventListener("click",()=>{this.showView("chat")}),document.querySelectorAll(".category-tabs .tab").forEach(s=>{s.addEventListener("click",async()=>{let o=s.dataset.category;document.querySelectorAll(".tab").forEach(a=>a.classList.remove("active")),s.classList.add("active");let n=document.getElementById("history-list");if(n){n.innerHTML='<div class="loading-history">Loading...</div>';let a=await window.historyManager.loadHistory(o);window.historyManager.renderHistoryList(n,a,o)}})});let d=document.getElementById("history-list");d&&d.addEventListener("click",async s=>{let o=s.target.closest(".history-item");if(!o)return;let n=o.dataset.category||"twitter",a=o.dataset.id;if(!a)return;if(s.target.classList.contains("btn-delete")){await window.TabTalkStorage.deleteSavedContent(n,a),o.remove(),window.TabTalkUI.showToast("Item deleted");return}let l=((await window.TabTalkStorage.getSavedContent())[n]||[]).find(u=>u.id===a);if(!l){window.TabTalkUI.showToast("Content not found");return}if(s.target.classList.contains("btn-copy")){await navigator.clipboard.writeText(l.content||""),window.TabTalkUI.showToast("Copied to clipboard");return}if(s.target.classList.contains("btn-view")){this.showView("chat");let u=n==="thread"?"thread":"twitter";this.addTwitterMessage("assistant",l.content||"",u)}})}};let E=r.prototype.init;r.prototype.init=async function(){return await E.call(this),this.initHistoryManager(),this},document.addEventListener("DOMContentLoaded",()=>{new r().init().catch(i=>console.error("Initialization error:",i))})})();})();
