(()=>{(()=>{var i=class{constructor(){this.apiKey=null,this.currentTab=null,this.pageContent=null,this.isLoading=!1,this.currentDomain=null,this.messagesContainer=document.getElementById("messages-container"),this.pageStatus=document.getElementById("page-status"),this.pageTitle=document.getElementById("page-title"),this.quickActions=document.getElementById("quick-actions"),this.sidebar=document.getElementById("sidebar"),this.quickTwitterBtn=document.getElementById("quick-twitter"),this.quickTwitterThreadBtn=document.getElementById("quick-twitter-thread"),this.quickCreateBtn=document.getElementById("quick-create"),this.welcomeView=document.getElementById("welcome-view"),this.apiSetupView=document.getElementById("api-setup-view"),this.chatView=document.getElementById("chat-view"),this.settingsView=document.getElementById("settings-view"),this.menuButton=document.getElementById("menu-button"),this.apiKeyInput=document.getElementById("api-key-input")||document.getElementById("settings-api-key"),this.inputActions=document.querySelector(".input-actions"),this.exportFormatSelect=document.getElementById("export-format-select"),this.statusText=document.getElementById("status-text"),this.views={welcome:this.welcomeView,"api-setup":this.apiSetupView,chat:this.chatView,settings:this.settingsView}}async init(){console.log("TabTalk AI: Initializing popup"),this.currentTab=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0],await this.loadState(),this.bindEvents();let t=await this.getStorageItem("hasSeenWelcome");this.apiKey?(this.showView("chat"),await this.getAndCachePageContent()):t?this.showView("api-setup"):this.showView("welcome"),console.log("TabTalk AI: Popup initialized")}bindEvents(){let t=document.getElementById("settings-cancel-button"),n=document.getElementById("settings-save-button");t&&t.addEventListener("click",()=>{this.updateViewState(this.apiKey?"chat":"settings")}),n&&n.addEventListener("click",()=>this.handleSaveSettings());let d=document.getElementById("delete-api-key-button");d&&d.addEventListener("click",()=>this.handleDeleteApiKey()),console.log("Menu Button:",this.menuButton),console.log("Sidebar:",this.sidebar),this.menuButton&&this.sidebar&&(this.menuButton.addEventListener("click",e=>{e.stopPropagation(),console.log("Menu button clicked!");let s=this.sidebar.classList.contains("hidden");s?(this.sidebar.classList.remove("hidden"),this.sidebar.style.display="block"):(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none"),console.log("Sidebar is now:",s?"visible":"hidden"),this.sidebar.setAttribute("aria-expanded",s?"false":"true")}),document.addEventListener("click",e=>{this.sidebar.classList.contains("hidden")||!this.sidebar.contains(e.target)&&e.target!==this.menuButton&&(this.sidebar.classList.add("hidden"),this.sidebar.setAttribute("aria-expanded","false"))}),this.sidebar.addEventListener("keydown",e=>{e.key==="Escape"&&(this.sidebar.classList.add("hidden"),this.sidebar.setAttribute("aria-expanded","false"),this.menuButton.focus())}));let r=document.getElementById("menu-settings-link");r&&r.addEventListener("click",e=>{e.preventDefault(),this.updateViewState("settings"),this.sidebar&&this.sidebar.classList.add("hidden")});let l=document.getElementById("menu-gallery-link");l&&l.addEventListener("click",e=>{e.preventDefault(),this.showView("gallery"),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")});let c=document.getElementById("menu-threads-link");c&&c.addEventListener("click",e=>{e.preventDefault(),this.showView("threads"),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")});let h=document.getElementById("welcome-get-started");h&&h.addEventListener("click",async()=>{await this.setStorageItem("hasSeenWelcome",!0),this.showView("api-setup")});let u=document.getElementById("welcome-start");u&&u.addEventListener("click",async()=>{await this.setStorageItem("hasSeenWelcome",!0),this.showView("api-setup")});let w=document.getElementById("api-setup-back");w&&w.addEventListener("click",()=>{this.showView("welcome")});let g=document.getElementById("api-setup-back-arrow");g&&g.addEventListener("click",()=>{this.showView("welcome")});let m=document.getElementById("api-setup-continue");m&&m.addEventListener("click",async()=>{let e=document.getElementById("onboarding-api-key").value.trim();e&&(await this.saveApiKey(e),this.showView("chat"),await this.getAndCachePageContent())});let a=document.getElementById("test-api-key");a&&a.addEventListener("click",async()=>{let e=document.getElementById("onboarding-api-key").value.trim();if(e){let s=await this.testApiKey(e),y=document.getElementById("api-setup-continue");s?(a.textContent="\u2713 Valid",a.style.background="#10b981",a.style.color="white",y.disabled=!1):(a.textContent="\u2717 Invalid",a.style.background="#ef4444",a.style.color="white",y.disabled=!0),setTimeout(()=>{a.textContent="Test",a.style.background="",a.style.color=""},2e3)}});let o=document.getElementById("onboarding-api-key");o&&o.addEventListener("input",()=>{let e=document.getElementById("api-setup-continue");e.disabled=!o.value.trim()}),this.menuButton&&this.menuButton.setAttribute("aria-label","Open menu"),this.apiKeyInput&&this.apiKeyInput.setAttribute("aria-label","Gemini API Key"),this.quickTwitterBtn&&this.quickTwitterBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSocialContent("twitter")}),this.quickTwitterThreadBtn&&this.quickTwitterThreadBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSocialContent("thread")}),this.quickCreateBtn&&this.quickCreateBtn.addEventListener("click",()=>{this.showView("thread-generator")});let p=document.getElementById("generate-thread-btn");p&&p.addEventListener("click",async()=>{this.handleThreadGeneratorSubmit&&await this.handleThreadGeneratorSubmit()}),this.initializeHorizontalScroll()}async testApiKey(t){try{let n=await chrome.runtime.sendMessage({action:"testApiKey",apiKey:t});return n&&n.success}catch(n){return console.error("Error testing API key:",n),!1}}async handleSaveSettings(){let t=this.apiKeyInput?this.apiKeyInput.value.trim():"";if(!t){alert("Please enter a valid API key");return}await this.testApiKey(t)?(await this.saveApiKey(t),console.log("TabTalk AI: Saving API key with key name 'geminiApiKey' successfully"),this.showView("chat"),await this.getAndCachePageContent()):alert("Invalid API key. Please try again.")}async getAndCachePageContent(){if(!(!this.currentTab||!this.apiKey)){this.setLoading(!0,"Reading page..."),this.pageStatus.textContent="Injecting script to read page...";try{if(this.currentTab.url?.startsWith("chrome://")||this.currentTab.url?.startsWith("https://chrome.google.com/webstore"))throw new Error("Cannot run on protected browser pages.");let t=await chrome.scripting.executeScript({target:{tabId:this.currentTab.id},files:["content.js"]});if(!t||t.length===0)throw new Error("Script injection failed.");let n=t[0].result;if(n.success)this.pageContent=n.content,this.pageStatus.textContent=`\u2705 Content loaded (${(n.content.length/1024).toFixed(1)} KB)`,this.updateQuickActionsVisibility();else throw new Error(n.error)}catch(t){console.error("TabTalk AI (popup):",t),this.pageStatus.textContent=`\u274C ${t.message}`}finally{this.setLoading(!1)}}}};window.TabTalkAPI&&Object.assign(i.prototype,window.TabTalkAPI),window.TabTalkTwitter&&Object.assign(i.prototype,window.TabTalkTwitter),window.TabTalkThreadGenerator&&Object.assign(i.prototype,window.TabTalkThreadGenerator),window.TabTalkContentAnalysis&&Object.assign(i.prototype,window.TabTalkContentAnalysis),window.TabTalkSocialMedia&&Object.assign(i.prototype,window.TabTalkSocialMedia),window.TabTalkStorage&&Object.assign(i.prototype,window.TabTalkStorage),window.TabTalkUI&&Object.assign(i.prototype,window.TabTalkUI),window.TabTalkScroll&&Object.assign(i.prototype,window.TabTalkScroll),window.TabTalkNavigation&&Object.assign(i.prototype,window.TabTalkNavigation);let b=i.prototype.init;i.prototype.init=async function(){return await b.call(this),this},document.addEventListener("DOMContentLoaded",()=>{new i().init().catch(t=>console.error("Initialization error:",t))})})();})();
