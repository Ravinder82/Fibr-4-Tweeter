(()=>{(()=>{var s=class{constructor(){this.apiKey=null,this.currentTab=null,this.chatHistory=[],this.pageContent=null,this.isLoading=!1,this.currentDomain=null,this.maxCharCount=2e3,this.charCount=document.querySelector(".char-count"),this.formatButtons=document.querySelectorAll(".format-button, .tool-button"),this.inputBar=document.querySelector(".input-bar"),this.messageInput=document.getElementById("message-input"),this.sendButton=document.getElementById("send-button"),this.messagesContainer=document.getElementById("messages-container"),this.pageStatus=document.getElementById("page-status"),this.pageTitle=document.getElementById("page-title"),this.quickActions=document.getElementById("quick-actions"),this.sidebar=document.getElementById("sidebar"),this.quickTwitterBtn=document.getElementById("quick-twitter"),this.quickTwitterThreadBtn=document.getElementById("quick-twitter-thread"),this.welcomeView=document.getElementById("welcome-view"),this.apiSetupView=document.getElementById("api-setup-view"),this.chatView=document.getElementById("chat-view"),this.settingsView=document.getElementById("settings-view"),this.menuButton=document.getElementById("menu-button"),this.apiKeyInput=document.getElementById("api-key-input")||document.getElementById("settings-api-key"),this.inputActions=document.querySelector(".input-actions"),this.exportFormatSelect=document.getElementById("export-format-select"),this.statusText=document.getElementById("status-text"),this.views={welcome:this.welcomeView,"api-setup":this.apiSetupView,chat:this.chatView,settings:this.settingsView}}async init(){console.log("TabTalk AI: Initializing popup"),this.currentTab=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0],await this.loadState(),this.bindEvents();let i=await this.getStorageItem("hasSeenWelcome");this.apiKey?(this.showView("chat"),await this.getAndCachePageContent()):i?this.showView("api-setup"):this.showView("welcome"),console.log("TabTalk AI: Popup initialized")}bindEvents(){let i=document.getElementById("settings-cancel-button"),e=document.getElementById("settings-save-button");i&&i.addEventListener("click",()=>{this.updateViewState(this.apiKey?"chat":"settings")}),e&&e.addEventListener("click",()=>this.handleSaveSettings());let d=document.getElementById("delete-api-key-button");d&&d.addEventListener("click",()=>this.handleDeleteApiKey()),console.log("Menu Button:",this.menuButton),console.log("Sidebar:",this.sidebar),this.menuButton&&this.sidebar&&(this.menuButton.addEventListener("click",t=>{t.stopPropagation(),console.log("Menu button clicked!");let h=this.sidebar.classList.contains("hidden");h?(this.sidebar.classList.remove("hidden"),this.sidebar.style.display="block"):(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none"),console.log("Sidebar is now:",h?"visible":"hidden"),this.sidebar.setAttribute("aria-expanded",h?"false":"true")}),document.addEventListener("click",t=>{this.sidebar.classList.contains("hidden")||!this.sidebar.contains(t.target)&&t.target!==this.menuButton&&(this.sidebar.classList.add("hidden"),this.sidebar.setAttribute("aria-expanded","false"))}),this.sidebar.addEventListener("keydown",t=>{t.key==="Escape"&&(this.sidebar.classList.add("hidden"),this.sidebar.setAttribute("aria-expanded","false"),this.menuButton.focus())}));let r=document.getElementById("menu-settings-link");r&&r.addEventListener("click",t=>{t.preventDefault(),this.updateViewState("settings"),this.sidebar&&this.sidebar.classList.add("hidden")});let l=document.getElementById("menu-gallery-link");l&&l.addEventListener("click",t=>{t.preventDefault(),this.showView("gallery"),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")});let a=document.getElementById("menu-thread-generator-link");a&&a.addEventListener("click",t=>{t.preventDefault(),this.showView("thread-generator"),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")});let o=document.getElementById("menu-threads-link");o&&o.addEventListener("click",t=>{t.preventDefault(),this.showView("threads"),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")});let u=document.getElementById("menu-refresh-link");u&&u.addEventListener("click",async t=>{t.preventDefault(),confirm("Clear all chat history for this page?")&&(this.chatHistory=[],await this.saveState(),this.renderMessages()),this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none")});let c=document.getElementById("welcome-get-started");c&&c.addEventListener("click",async()=>{await this.setStorageItem("hasSeenWelcome",!0),this.showView("api-setup")});let w=document.getElementById("welcome-start");w&&w.addEventListener("click",async()=>{await this.setStorageItem("hasSeenWelcome",!0),this.showView("api-setup")});let b=document.getElementById("api-setup-back");b&&b.addEventListener("click",()=>{this.showView("welcome")});let k=document.getElementById("api-setup-back-arrow");k&&k.addEventListener("click",()=>{this.showView("welcome")});let E=document.getElementById("api-setup-continue");E&&E.addEventListener("click",async()=>{let t=document.getElementById("onboarding-api-key").value.trim();t&&(await this.saveApiKey(t),this.showView("chat"),await this.getAndCachePageContent())});let n=document.getElementById("test-api-key");n&&n.addEventListener("click",async()=>{let t=document.getElementById("onboarding-api-key").value.trim();if(t){let h=await this.testApiKey(t),T=document.getElementById("api-setup-continue");h?(n.textContent="\u2713 Valid",n.style.background="#10b981",n.style.color="white",T.disabled=!1):(n.textContent="\u2717 Invalid",n.style.background="#ef4444",n.style.color="white",T.disabled=!0),setTimeout(()=>{n.textContent="Test",n.style.background="",n.style.color=""},2e3)}});let y=document.getElementById("onboarding-api-key");y&&y.addEventListener("input",()=>{let t=document.getElementById("api-setup-continue");t.disabled=!y.value.trim()}),this.sendButton&&this.sendButton.addEventListener("click",()=>this.sendMessage()),this.messageInput&&(this.messageInput.addEventListener("input",()=>this.handleInputChange()),this.messageInput.addEventListener("keydown",t=>this.handleInputKeydown(t)),this.messageInput.addEventListener("focus",()=>{this.inputBar.classList.add("focused"),this.messageInput.setAttribute("aria-expanded","true")}),this.messageInput.addEventListener("blur",()=>{this.inputBar.classList.remove("focused"),this.messageInput.setAttribute("aria-expanded","false")}));let g=this.inputActions?this.inputActions.querySelector("#clear-chat-button"):document.getElementById("clear-chat-button");g&&g.addEventListener("click",async()=>{confirm("Clear all chat history for this page?")&&(this.chatHistory=[],await this.saveState(),this.renderMessages())});let m=this.inputActions?this.inputActions.querySelector("#export-chat-button"):document.getElementById("export-chat-button");m&&m.addEventListener("click",()=>this.handleExportChat());let p=this.inputActions?this.inputActions.querySelector("#export-format-select"):document.getElementById("export-format-select");p&&p.setAttribute("aria-label","Export format"),this.sendButton&&this.sendButton.setAttribute("aria-label","Send message"),g&&g.setAttribute("aria-label","Clear chat history"),m&&m.setAttribute("aria-label","Export chat"),p&&p.setAttribute("aria-label","Export format"),this.menuButton&&this.menuButton.setAttribute("aria-label","Open menu"),this.apiKeyInput&&this.apiKeyInput.setAttribute("aria-label","Gemini API Key"),document.addEventListener("keydown",t=>{(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="i"&&(t.preventDefault(),this.messageInput&&this.messageInput.focus())}),this.formatButtons.forEach(t=>{t.addEventListener("click",h=>{h.preventDefault(),t.id==="clear-chat-button"?this.handleClearChat():t.id==="export-chat-button"?this.handleExportChat():this.handleFormatting(t.getAttribute("title").toLowerCase())})}),this.quickTwitterBtn&&this.quickTwitterBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSocialContent("twitter")}),this.quickTwitterThreadBtn&&this.quickTwitterThreadBtn.addEventListener("click",async()=>{this.resetScreenForGeneration&&this.resetScreenForGeneration(),await this.generateSocialContent("thread")});let I=document.getElementById("generate-thread-btn");I&&I.addEventListener("click",async()=>{this.handleThreadGeneratorSubmit&&await this.handleThreadGeneratorSubmit()}),this.initializeHorizontalScroll()}async testApiKey(i){try{let e=await chrome.runtime.sendMessage({action:"testApiKey",apiKey:i});return e&&e.success}catch(e){return console.error("Error testing API key:",e),!1}}async handleSaveSettings(){let i=this.apiKeyInput?this.apiKeyInput.value.trim():"";if(!i){alert("Please enter a valid API key");return}await this.testApiKey(i)?(await this.saveApiKey(i),console.log("TabTalk AI: Saving API key with key name 'geminiApiKey' successfully"),this.showView("chat"),await this.getAndCachePageContent()):alert("Invalid API key. Please try again.")}async getAndCachePageContent(){if(!(!this.currentTab||!this.apiKey)){this.setLoading(!0,"Reading page..."),this.pageStatus.textContent="Injecting script to read page...";try{if(this.currentTab.url?.startsWith("chrome://")||this.currentTab.url?.startsWith("https://chrome.google.com/webstore"))throw new Error("Cannot run on protected browser pages.");let i=await chrome.scripting.executeScript({target:{tabId:this.currentTab.id},files:["content.js"]});if(!i||i.length===0)throw new Error("Script injection failed.");let e=i[0].result;if(e.success)this.pageContent=e.content,this.pageStatus.textContent=`\u2705 Content loaded (${(e.content.length/1024).toFixed(1)} KB)`,this.updateQuickActionsVisibility();else throw new Error(e.error)}catch(i){console.error("TabTalk AI (popup):",i),this.pageStatus.textContent=`\u274C ${i.message}`}finally{this.setLoading(!1)}}}async sendMessage(){if(!this.messageInput||this.isLoading||!this.messageInput.value.trim())return;let i=this.messageInput.value.trim();this.messageInput.value="",this.handleInputChange(),this.messageInput.focus();try{this.setLoading(!0,"Sending message..."),this.addMessage("user",i),this.messagesContainer.scrollTo({top:this.messagesContainer.scrollHeight,behavior:"smooth"});let e=await this.callGeminiAPI(i);e&&(this.addMessage("assistant",e),this.messagesContainer.scrollTo({top:this.messagesContainer.scrollHeight,behavior:"smooth"}))}catch(e){console.error("Error sending message:",e),this.setAriaStatus("Error sending message: "+e.message),this.addMessage("assistant","Sorry, there was an error processing your message. Please try again.")}finally{this.setLoading(!1)}}async handleRefresh(){this.sidebar&&(this.sidebar.classList.add("hidden"),this.sidebar.style.display="none"),this.pageContent=null,this.chatHistory=[],await this.saveState(),this.updateViewState("status","Refreshing..."),await this.getAndCachePageContent(),this.renderMessages()}handleFormatting(i){let e=this.messageInput,d=e.selectionStart,r=e.selectionEnd,l=e.value,a="",o="";switch(i){case"bold":a="**",o="**";break;case"italic":a="_",o="_";break;case"code":l.substring(d,r).includes(`
`)?(a="```\n",o="\n```"):(a="`",o="`");break;case"link":d===r?(a="[",o="](url)"):(a="[",o="](https://)");break}let u=l.substring(0,d)+a+l.substring(d,r)+o+l.substring(r);e.value=u;let c=r+a.length;e.setSelectionRange(c,c+(d===r?0:r-d)),this.handleInputChange(),e.focus()}async handleClearChat(){confirm("Clear all chat history for this page?")&&(this.chatHistory=[],await this.saveState(),this.renderMessages())}};window.TabTalkAPI&&Object.assign(s.prototype,window.TabTalkAPI),window.TabTalkExport&&Object.assign(s.prototype,window.TabTalkExport),window.TabTalkTwitter&&Object.assign(s.prototype,window.TabTalkTwitter),window.TabTalkThreadGenerator&&Object.assign(s.prototype,window.TabTalkThreadGenerator),window.TabTalkContentAnalysis&&Object.assign(s.prototype,window.TabTalkContentAnalysis),window.TabTalkSocialMedia&&Object.assign(s.prototype,window.TabTalkSocialMedia),window.TabTalkStorage&&Object.assign(s.prototype,window.TabTalkStorage),window.TabTalkUI&&Object.assign(s.prototype,window.TabTalkUI),window.TabTalkScroll&&Object.assign(s.prototype,window.TabTalkScroll),window.TabTalkNavigation&&Object.assign(s.prototype,window.TabTalkNavigation);let v=s.prototype.init;s.prototype.init=async function(){return await v.call(this),this},document.addEventListener("DOMContentLoaded",()=>{new s().init().catch(i=>console.error("Initialization error:",i))})})();})();
