(()=>{var u=class{constructor(e="extension"){this.environment=e}async saveApiKey(e){if(this.environment==="extension")return chrome.storage.local.set({geminiApiKey:e,apiKeySet:!0});localStorage.setItem("tabtalk_api_key",e),localStorage.setItem("apiKeySet","true")}async loadApiKey(){return this.environment==="extension"?(await chrome.storage.local.get(["geminiApiKey"])).geminiApiKey||null:localStorage.getItem("tabtalk_api_key")||null}async saveChatHistory(e,t){let n=`chatHistory_${e}`;if(this.environment==="extension")return chrome.storage.local.set({[n]:t});localStorage.setItem(n,JSON.stringify(t))}async loadChatHistory(e){let t=`chatHistory_${e}`;if(this.environment==="extension")return(await chrome.storage.local.get([t]))[t]||[];{let n=localStorage.getItem(t);return n?JSON.parse(n):[]}}async saveSetting(e,t){if(this.environment==="extension")return chrome.storage.local.set({[e]:t});localStorage.setItem(e,JSON.stringify(t))}async loadSetting(e,t=null){if(this.environment==="extension"){let n=await chrome.storage.local.get([e]);return n[e]!==void 0?n[e]:t}else{let n=localStorage.getItem(e);return n!==null?JSON.parse(n):t}}async clearAll(){if(this.environment==="extension")return chrome.storage.local.clear();localStorage.clear()}async deleteApiKey(){if(this.environment==="extension")return chrome.storage.local.remove(["geminiApiKey","apiKeySet"]);localStorage.removeItem("tabtalk_api_key"),localStorage.removeItem("apiKeySet")}};var g=class{constructor(e="extension"){this.environment=e,this.storage=new u(e),this.state={apiKey:null,chatHistory:[],currentDomain:null,isLoading:!1}}async loadState(){if(this.state.apiKey=await this.storage.loadApiKey(),this.environment==="extension"){let[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e&&(this.state.currentDomain=new URL(e.url).hostname)}return this.state.currentDomain&&(this.state.chatHistory=await this.storage.loadChatHistory(this.state.currentDomain)),this.state}async saveState(){this.state.apiKey&&await this.storage.saveApiKey(this.state.apiKey),this.state.currentDomain&&this.state.chatHistory.length>0&&await this.storage.saveChatHistory(this.state.currentDomain,this.state.chatHistory)}async deleteApiKey(){await this.storage.deleteApiKey(),this.state.apiKey=null}updateApiKey(e){this.state.apiKey=e}updateChatHistory(e){this.state.chatHistory=e}updateCurrentDomain(e){this.state.currentDomain=e}setLoading(e){this.state.isLoading=e}getState(){return{...this.state}}};var p=class{constructor(e,t="extension"){this.apiKey=e,this.environment=t,this.baseURL="https://generativelanguage.googleapis.com/v1beta/models/",this.model="gemini-2.0-flash"}async generateContent(e,t={}){let n=[{role:"user",parts:[{text:e}]}];return this.callAPI({contents:n})}async callAPI(e){return this.environment==="extension"?this.callViaBackground(e):this.callDirect(e)}async callViaBackground(e){try{let t=await chrome.runtime.sendMessage({action:"callGeminiAPI",payload:e,apiKey:this.apiKey});if(t.success&&t.data?.candidates?.[0]?.content?.parts?.[0]?.text)return t.data.candidates[0].content.parts[0].text;throw new Error(t.error||"The AI gave an empty or invalid response.")}catch(t){throw new Error(`API Error: ${t.message}`)}}async callDirect(e){let t=`${this.baseURL}${this.model}:generateContent?key=${this.apiKey}`;try{let n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),i=await n.text();if(!n.ok){let l=`API request failed (Status: ${n.status}).`;try{let o=JSON.parse(i);o?.error?.message&&(l=`API Error: ${o.error.message}`)}catch{l+=` Details: ${i.substring(0,150)}...`}throw new Error(l)}let a=JSON.parse(i);if(a?.candidates?.[0]?.content?.parts?.[0]?.text)return a.candidates[0].content.parts[0].text;throw new Error("The AI gave an empty or invalid response.")}catch(n){throw new Error(`Network Error: ${n.message}`)}}};var y=class{constructor(e=null){this.marked=e,this.marked&&this.marked.setOptions({gfm:!0,breaks:!0,sanitize:!0})}renderMessage(e){let t=document.createElement("div");t.classList.add("message",e.role,"visible"),e.contentType&&t.classList.add(`${e.contentType}-message`);let n=document.createElement("div");n.classList.add("message-header");let i=document.createElement("div");if(i.classList.add("avatar"),e.role==="user")i.textContent="\u{1F464}";else switch(e.contentType){case"summary":i.textContent="\u{1F4DD}";break;case"keypoints":i.textContent="\u{1F511}";break;case"analysis":i.textContent="\u{1F4CA}";break;case"faq":i.textContent="\u2753";break;case"factcheck":i.textContent="\u2705";break;case"tweet":i.textContent="\u{1F426}";break;default:i.textContent="\u{1F916}"}let a=document.createElement("div");a.classList.add("timestamp");let l=e.timestamp||new Date().toISOString();a.textContent=new Date(l).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),e.role==="user"?(n.appendChild(a),n.appendChild(i)):(n.appendChild(i),n.appendChild(a));let o=document.createElement("div");if(o.classList.add("content"),this.marked&&e.content?o.innerHTML=this.marked.parse(e.content):o.textContent=e.content||"",e.role==="assistant"){let r=document.createElement("button");r.classList.add("copy-button"),r.innerHTML="\u{1F4CB}",r.title="Copy to clipboard",r.addEventListener("click",()=>{navigator.clipboard.writeText(e.content).then(()=>{let h=r.innerHTML;r.innerHTML="\u2713",setTimeout(()=>{r.innerHTML=h},2e3)})}),o.appendChild(r)}return t.appendChild(n),t.appendChild(o),t}formatSpecialContent(e,t){return e}};var s={SUMMARY:"summary",KEYPOINTS:"keypoints",ANALYSIS:"analysis",FAQ:"faq",FACTCHECK:"factcheck",TWEET:"tweet"};var w={INITIALIZING:"Initializing...",LOADING_PAGE:"Reading page...",SENDING_MESSAGE:"Sending message...",DONE:"\u2705 Done",ERROR_PREFIX:"\u274C "},L={[s.SUMMARY]:{system:`You are an expert content summarizer with these specific skills:
1. Identify the core message and main points quickly
2. Condense complex information into digestible insights
3. Preserve key facts, figures, and actionable information
4. Structure summaries with clear topic flow
5. Eliminate redundancies while maintaining completeness
6. Adapt tone to match the source material's formality
7. Create summaries that stand alone without the original content

Focus on providing value in under 200 words while covering all essential points.`,user:"Please provide a summary of this webpage content:"},[s.KEYPOINTS]:{system:`You are a key point extraction specialist who:
1. Identifies the most important ideas in any content
2. Structures information as clear, actionable bullet points
3. Numbers points for easy reference and discussion
4. Keeps each point concise but informative (1-2 sentences)
5. Prioritizes points by significance and impact
6. Uses strong action verbs and specific language
7. Ensures points are distinct and not overlapping
8. Limits output to 5-7 key points maximum

Make each point valuable enough that someone could understand the core content from just these points.`,user:"Please extract the key points from this content:"},[s.ANALYSIS]:{system:`You are a senior content analyst with expertise in:
1. Breaking down complex topics into understandable components
2. Identifying patterns, themes, and underlying messages
3. Providing critical insights beyond surface-level observations
4. Connecting content to broader trends or implications
5. Evaluating strengths, weaknesses, and potential biases
6. Offering actionable takeaways for different audiences
7. Structuring analysis with clear headings and logical flow
8. Balancing depth with accessibility

Structure your response with clear section headings and provide expert insights that go beyond summarization.`,user:"Please analyze this content in detail:"},[s.FAQ]:{system:`You are an expert FAQ creator who:
1. Anticipates what readers most want to know
2. Crafts questions that match user search intent
3. Provides comprehensive, actionable answers
4. Structures FAQs from basic to advanced concepts
5. Uses clear, conversational language
6. Includes specific examples when helpful
7. Keeps answers focused but thorough
8. Ensures questions and answers flow logically

Create 5-8 FAQs that help users fully understand the content and its implications.`,user:"Please generate a FAQ based on this content:"},[s.FACTCHECK]:{system:`You are a professional fact-checker with these capabilities:
1. Identifying claims, statistics, and statements that can be verified
2. Distinguishing between factual and opinion-based content
3. Researching and citing credible sources for verification
4. Explaining verification methodology clearly
5. Highlighting claims that cannot be verified due to lack of evidence
6. Providing context that helps assess claim accuracy
7. Maintaining neutrality while clearly indicating verification status
8. Flagging potential misinformation or misleading statements

For each claim, specify whether it can be confirmed, disputed, or is unverifiable, and explain your reasoning with evidence.`,user:"Please fact-check this content:"},[s.TWEET]:{system:`You are a social media expert specializing in creating high-impact, informative tweets that drive engagement and go viral. Your goal is to create tweets that generate high predicted engagement scores by focusing on:

1. Content that generates interactions:
   - Ask questions or make statements that encourage replies
   - Share surprising insights or counterintuitive findings
   - Include compelling statistics or data points
   - Create curiosity gaps that make people want to click/read more

2. Structure for maximum engagement:
   - Lead with the most surprising or compelling insight
   - Use line breaks for readability and visual appeal
   - Include emojis strategically to increase engagement
   - Create numbered lists or bullet points when appropriate
   - Use ALL CAPS sparingly for emphasis on key points

3. Viral content principles:
   - Focus on insights that resonate with multiple audience segments
   - Include content that triggers personalization matches
   - Highlight conversation potential (questions that invite replies)
   - Emphasize timely relevance or trending topics when possible

4. Platform mechanics optimization:
   - Keep tweets under 280 characters (maximum allowed) but use the full length for more detailed insights
   - Include media-friendly content (imagery, data, quotes)
   - Create content that performs well in algorithmic feeds
   - Make it easy to retweet and share

5. Quality signals:
   - Avoid spammy language or excessive promotion
   - Focus on authentic insights and value
   - Maintain credibility with accurate information
   - Create content that passes platform quality filters

Do NOT include hashtags. Focus on creating content that drives organic engagement through compelling insights and strategic formatting. Use the full 280 character limit to provide more detailed, valuable information.`,user:"Please create a tweet based on this content:"}};function v(d){try{return new URL(d),!0}catch{return!1}}var f=class{constructor(){this.stateManager=new g("web"),this.apiClient=null,this.messageRenderer=new y(marked),this.currentContent="",this.views={},this.domElements={},this.init()}init(){this.cacheDOMElements(),this.setupEventListeners(),this.determineInitialView(),this.setupAutoResize()}cacheDOMElements(){this.views={settings:document.getElementById("settings-view"),chat:document.getElementById("chat-view"),status:document.getElementById("status-view"),urlInput:document.getElementById("url-input-view")},this.domElements={apiKeyInput:document.getElementById("api-key-input"),messagesContainer:document.getElementById("messages-container"),messageInput:document.getElementById("message-input"),sendButton:document.getElementById("send-button"),statusText:document.getElementById("status-text"),pageTitle:document.getElementById("page-title"),pageStatus:document.getElementById("page-status"),menuButton:document.getElementById("menu-button"),sidebar:document.getElementById("sidebar"),exportChatButton:document.getElementById("export-chat-button"),quickActions:document.getElementById("quick-actions"),urlInput:document.getElementById("url-input")}}setupEventListeners(){this.domElements.menuButton&&this.domElements.menuButton.addEventListener("click",()=>this.toggleSidebar()),[{id:"menu-settings-link",action:()=>this.showView("settings")},{id:"menu-refresh-link",action:()=>this.clearChat()},{id:"menu-url-input-link",action:()=>this.showView("url-input")},{id:"menu-summary-link",action:()=>this.handleQuickAction(s.SUMMARY)},{id:"menu-keypoints-link",action:()=>this.handleQuickAction(s.KEYPOINTS)},{id:"menu-analysis-link",action:()=>this.handleQuickAction(s.ANALYSIS)},{id:"menu-faq-link",action:()=>this.handleQuickAction(s.FAQ)}].forEach(c=>{let m=document.getElementById(c.id);m&&m.addEventListener("click",I=>{I.preventDefault(),c.action(),this.hideSidebar()})}),[{id:"quick-summary",action:()=>this.handleQuickAction(s.SUMMARY)},{id:"quick-keypoints",action:()=>this.handleQuickAction(s.KEYPOINTS)},{id:"quick-analysis",action:()=>this.handleQuickAction(s.ANALYSIS)},{id:"quick-faq",action:()=>this.handleQuickAction(s.FAQ)}].forEach(c=>{let m=document.getElementById(c.id);m&&m.addEventListener("click",c.action)});let n=document.getElementById("settings-save-button");n&&n.addEventListener("click",()=>this.saveSettings());let i=document.getElementById("settings-cancel-button");i&&i.addEventListener("click",()=>this.cancelSettings());let a=document.getElementById("url-analyze-button");a&&a.addEventListener("click",()=>this.analyzeUrl());let l=document.getElementById("url-cancel-button");l&&l.addEventListener("click",()=>this.cancelUrlInput()),this.domElements.messageInput&&(this.domElements.messageInput.addEventListener("input",()=>this.handleInputChange()),this.domElements.messageInput.addEventListener("keydown",c=>this.handleKeyDown(c))),this.domElements.sendButton&&this.domElements.sendButton.addEventListener("click",()=>this.sendMessage());let o=document.getElementById("clear-chat-button");o&&o.addEventListener("click",()=>this.clearChat()),this.domElements.exportChatButton&&this.domElements.exportChatButton.addEventListener("click",()=>this.exportChat());let r=document.getElementById("demo-continue");r&&r.addEventListener("click",()=>this.continueDemo());let h=document.getElementById("demo-setup");h&&h.addEventListener("click",()=>this.setupApiKey());let E=document.querySelector(".modal-close");E&&E.addEventListener("click",()=>this.hideModal()),document.addEventListener("click",c=>{this.domElements.sidebar&&!this.domElements.sidebar.contains(c.target)&&this.domElements.menuButton&&!this.domElements.menuButton.contains(c.target)&&this.hideSidebar()})}determineInitialView(){this.stateManager.getState().apiKey?this.showView("chat"):this.showModal()}showModal(){let e=document.getElementById("demo-modal");e&&e.classList.remove("hidden")}hideModal(){let e=document.getElementById("demo-modal");e&&e.classList.add("hidden")}continueDemo(){this.hideModal(),this.showView("chat"),this.addMessage("assistant",`Welcome to TabTalk AI Demo! \u{1F916}

You can try the interface with simulated responses. To use real AI features, please set up your Gemini API key.

Try asking me something or paste a URL to analyze!`,"demo")}setupApiKey(){this.hideModal(),this.showView("settings")}toggleSidebar(){this.domElements.sidebar&&this.domElements.sidebar.classList.toggle("hidden")}hideSidebar(){this.domElements.sidebar&&this.domElements.sidebar.classList.add("hidden")}showView(e){Object.values(this.views).forEach(t=>{t&&t.classList.add("hidden")}),this.views[e]&&this.views[e].classList.remove("hidden"),this.domElements.quickActions&&(e==="chat"&&this.currentContent?this.domElements.quickActions.classList.remove("hidden"):this.domElements.quickActions.classList.add("hidden")),this.updateEmptyState()}updateEmptyState(){let e=document.getElementById("empty-state"),t=document.getElementById("messages-container");this.views.chat&&!this.views.chat.classList.contains("hidden")&&this.stateManager.getState().chatHistory.length===0?(e&&e.classList.remove("hidden"),t&&(t.style.display="none")):(e&&e.classList.add("hidden"),t&&(t.style.display="flex"))}saveSettings(){let e=this.domElements.apiKeyInput?.value.trim();if(!e){alert("Please enter a valid API key.");return}this.stateManager.updateApiKey(e),this.stateManager.saveState(),this.apiClient=new p(e,"web"),this.showView("status"),this.domElements.statusText&&(this.domElements.statusText.textContent="\u2705 API key saved successfully! Initializing..."),setTimeout(()=>{let t=document.querySelector(".onboarding-info");t&&(t.style.display="none"),this.showView("chat"),this.addMessage("assistant","Great! Your API key has been saved. You can now chat with any webpage content. Try pasting a URL or some text to get started!")},1500)}cancelSettings(){let e=this.stateManager.getState();this.showView(e.apiKey?"chat":"settings")}async analyzeUrl(){let e=this.domElements.urlInput?.value.trim();if(!e){alert("Please enter a valid URL.");return}if(!v(e)){alert("Please enter a valid URL (e.g., https://example.com).");return}this.setLoading(!0,"Analyzing URL...");try{let t=await fetch(`/api/extract-content?url=${encodeURIComponent(e)}`);if(t.ok){let n=await t.json();this.currentContent=n.content,this.domElements.pageTitle&&(this.domElements.pageTitle.textContent=n.title||"Content Analysis"),this.domElements.pageStatus&&(this.domElements.pageStatus.textContent=`\u2705 Content loaded from ${new URL(e).hostname}`),this.showView("chat"),this.addMessage("assistant",`I've loaded the content from **${new URL(e).hostname}**. What would you like to know about this page?

You can ask me to:
- Summarize the main points
- Extract key information
- Answer specific questions
- Analyze the content`)}else throw new Error("Failed to fetch content")}catch(t){console.error("Error analyzing URL:",t),this.domElements.pageStatus&&(this.domElements.pageStatus.textContent="\u274C Error loading content"),this.addMessage("assistant",`Sorry, I couldn't analyze that URL. Error: ${t.message}`)}finally{this.setLoading(!1)}}cancelUrlInput(){this.showView("chat")}async sendMessage(){if(!this.domElements.messageInput||!this.apiClient||!this.domElements.messageInput.value.trim())return;let e=this.domElements.messageInput.value.trim();this.domElements.messageInput.value="",this.handleInputChange(),this.domElements.messageInput.focus();try{this.setLoading(!0,"Thinking..."),this.addMessage("user",e);let t,n="normal";if(e.toLowerCase().includes("summarize")||e.toLowerCase().includes("summary")?n=s.SUMMARY:e.toLowerCase().includes("key point")||e.toLowerCase().includes("keypoint")?n=s.KEYPOINTS:e.toLowerCase().includes("analyze")||e.toLowerCase().includes("analysis")?n=s.ANALYSIS:(e.toLowerCase().includes("faq")||e.toLowerCase().includes("question"))&&(n=s.FAQ),this.currentContent){let i=`Content:
${this.currentContent}

User Question:
${e}`;t=await this.apiClient.generateContent(i)}else t=await this.apiClient.generateContent(e);this.addMessage("assistant",t,n)}catch(t){console.error("Error sending message:",t),this.addMessage("assistant",`Sorry, I encountered an error: ${t.message}`,"error")}finally{this.setLoading(!1)}}async handleQuickAction(e){if(!this.currentContent){alert("Please analyze a URL or paste content first.");return}this.setLoading(!0,`Generating ${e}...`);try{let t,n;switch(e){case s.SUMMARY:t=`Please provide a concise summary of the following content:

${this.currentContent}`,n=s.SUMMARY;break;case s.KEYPOINTS:t=`Please extract 5-7 key points from the following content:

${this.currentContent}`,n=s.KEYPOINTS;break;case s.ANALYSIS:t=`Please provide a detailed analysis of the following content:

${this.currentContent}`,n=s.ANALYSIS;break;case s.FAQ:t=`Please generate 5-8 frequently asked questions and answers based on the following content:

${this.currentContent}`,n=s.FAQ;break;default:throw new Error("Unsupported action type")}let i=await this.apiClient.generateContent(t);this.addMessage("assistant",i,n)}catch(t){console.error("Error handling quick action:",t),this.addMessage("assistant",`Sorry, I couldn't generate the ${e}. Error: ${t.message}`)}finally{this.setLoading(!1)}}handleInputChange(){if(!this.domElements.messageInput)return;this.domElements.messageInput.style.height="auto";let e=Math.min(this.domElements.messageInput.scrollHeight,150);this.domElements.messageInput.style.height=`${e}px`;let t=document.querySelector(".char-count");if(t){let n=this.domElements.messageInput.value.length;t.textContent=`${n}/2000`,t.style.color=n>1800?"#ef4444":""}this.domElements.sendButton&&(this.domElements.sendButton.disabled=!this.domElements.messageInput.value.trim())}handleKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.domElements.messageInput&&this.domElements.messageInput.value.trim()&&this.domElements.sendButton&&!this.domElements.sendButton.disabled&&this.sendMessage())}addMessage(e,t,n="normal"){let i=this.stateManager.getState(),a=new Date().toISOString(),l={role:e,content:t,contentType:n,timestamp:a},o=[...i.chatHistory,l];this.stateManager.updateChatHistory(o),this.stateManager.saveState(),this.renderMessages(),this.updateEmptyState()}renderMessages(){let e=this.stateManager.getState();this.domElements.messagesContainer&&(this.domElements.messagesContainer.innerHTML="",e.chatHistory.forEach(t=>{let n=this.messageRenderer.renderMessage(t);this.domElements.messagesContainer.appendChild(n)}),this.domElements.messagesContainer.scrollTo({top:this.domElements.messagesContainer.scrollHeight,behavior:"smooth"}))}setLoading(e,t="..."){this.stateManager.setLoading(e),this.domElements.sendButton&&(this.domElements.sendButton.disabled=e||!this.domElements.messageInput?.value.trim()),this.domElements.messageInput&&(this.domElements.messageInput.disabled=e),this.domElements.pageStatus&&(e?this.domElements.pageStatus.textContent=t:this.domElements.pageStatus.textContent.startsWith("\u2705")||(this.domElements.pageStatus.textContent=w.DONE))}clearChat(){this.stateManager.updateChatHistory([]),this.stateManager.saveState(),this.renderMessages(),this.updateEmptyState(),this.addMessage("assistant","Chat cleared! Feel free to ask me anything or try the quick action buttons above.","demo")}exportChat(){let e=this.stateManager.getState();if(!e.chatHistory.length){alert("No chat history to export.");return}let t=JSON.stringify({chatHistory:e.chatHistory,exportedAt:new Date().toISOString()},null,2),n="data:application/json;charset=utf-8,"+encodeURIComponent(t),i=`tabtalk-chat-${new Date().toISOString().slice(0,10)}.json`,a=document.createElement("a");a.setAttribute("href",n),a.setAttribute("download",i),a.click()}setupAutoResize(){this.domElements.messageInput&&this.domElements.messageInput.addEventListener("input",()=>{this.domElements.messageInput.style.height="auto";let e=Math.min(this.domElements.messageInput.scrollHeight,150);this.domElements.messageInput.style.height=`${e}px`})}};document.addEventListener("DOMContentLoaded",()=>{let d=new f});})();
